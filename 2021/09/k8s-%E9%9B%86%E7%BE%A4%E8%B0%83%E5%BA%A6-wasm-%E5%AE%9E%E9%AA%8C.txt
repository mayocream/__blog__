1:"$Sreact.fragment"
2:I[5803,[],""]
3:I[695,[],""]
5:I[2576,[],"OutletBoundary"]
7:I[2576,[],"MetadataBoundary"]
9:I[2576,[],"ViewportBoundary"]
b:I[7614,[],""]
:HL["/_next/static/css/c3b55921f92a131e.css","style"]
0:{"P":null,"b":"m6A-Tc8bnMTyQXrjIe8w0","p":"","c":["","2021","09","k8s-%25E9%259B%2586%25E7%25BE%25A4%25E8%25B0%2583%25E5%25BA%25A6-wasm-%25E5%25AE%259E%25E9%25AA%258C"],"i":false,"f":[[["",{"children":["(posts)",{"children":[["year","2021","d"],{"children":[["month","09","d"],{"children":[["slug","k8s-%25E9%259B%2586%25E7%25BE%25A4%25E8%25B0%2583%25E5%25BA%25A6-wasm-%25E5%25AE%259E%25E9%25AA%258C","d"],{"children":["__PAGE__",{}]}]}]}]}]},"$undefined","$undefined",true],["",["$","$1","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/c3b55921f92a131e.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","html",null,{"children":["$","body",null,{"className":"antialiased","children":["$","$L2",null,{"parallelRouterKey":"children","segmentPath":["children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L3",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[[],[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":404}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]]],"forbidden":"$undefined","unauthorized":"$undefined"}]}]}]]}],{"children":["(posts)",["$","$1","c",{"children":[null,["$","$L2",null,{"parallelRouterKey":"children","segmentPath":["children","(posts)","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L3",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[[],[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":"$0:f:0:1:1:props:children:1:props:children:props:children:props:notFound:1:1:props:style","children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":"$0:f:0:1:1:props:children:1:props:children:props:children:props:notFound:1:1:props:children:props:children:1:props:style","children":404}],["$","div",null,{"style":"$0:f:0:1:1:props:children:1:props:children:props:children:props:notFound:1:1:props:children:props:children:2:props:style","children":["$","h2",null,{"style":"$0:f:0:1:1:props:children:1:props:children:props:children:props:notFound:1:1:props:children:props:children:2:props:children:props:style","children":"This page could not be found."}]}]]}]}]]],"forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":[["year","2021","d"],["$","$1","c",{"children":[null,["$","$L2",null,{"parallelRouterKey":"children","segmentPath":["children","(posts)","children","$0:f:0:1:2:children:2:children:0","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L3",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":[["month","09","d"],["$","$1","c",{"children":[null,["$","$L2",null,{"parallelRouterKey":"children","segmentPath":["children","(posts)","children","$0:f:0:1:2:children:2:children:0","children","$0:f:0:1:2:children:2:children:2:children:0","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L3",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":[["slug","k8s-%25E9%259B%2586%25E7%25BE%25A4%25E8%25B0%2583%25E5%25BA%25A6-wasm-%25E5%25AE%259E%25E9%25AA%258C","d"],["$","$1","c",{"children":[null,["$","$L2",null,{"parallelRouterKey":"children","segmentPath":["children","(posts)","children","$0:f:0:1:2:children:2:children:0","children","$0:f:0:1:2:children:2:children:2:children:0","children","$0:f:0:1:2:children:2:children:2:children:2:children:0","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L3",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":["__PAGE__",["$","$1","c",{"children":["$L4",null,["$","$L5",null,{"children":"$L6"}]]}],{},null,false]},null,false]},null,false]},null,false]},null,false]},null,false],["$","$1","h",{"children":[null,["$","$1","Na3DYbSgGwXZo9gY2EQpM",{"children":[["$","$L7",null,{"children":"$L8"}],["$","$L9",null,{"children":"$La"}],null]}]]}],false]],"m":"$undefined","G":["$b","$undefined"],"s":false,"S":true}
a:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
8:[["$","meta","0",{"charSet":"utf-8"}],["$","title","1",{"children":"Mayo Rocks!"}],["$","meta","2",{"name":"description","content":"Mayo's Blog"}],["$","link","3",{"rel":"icon","href":"/icon.png?14d5a92fbe70e82a","type":"image/png","sizes":"460x460"}]]
6:null
c:T517c,<p>Webassembly（WASM）是 Next-Generation 的软件分发方式，具有跨语言、跨平台、自带运行时的无敌属性<sup><a href="#user-content-fn-1" id="user-content-fnref-1" data-footnote-ref aria-describedby="footnote-label">1</a></sup>。知晓了它的美妙之处，我们自然会想拥有次世代的体验，本文描述尝试将轻量级 WASM 用类 OCI 打包方式调度到 K8s 集群中运行的过程，以及其中的艰辛之处。</p>
<p>WASM 在当前阶段还很尴尬，WASI（WebAssembly System Interface）还处于<a href="https://github.com/WebAssembly/WASI/milestone/1">早期阶段</a>，WASM 运行时项目 <a href="https://github.com/wasmerio/wasmer">Wasmer</a> 与 <a href="https://github.com/bytecodealliance/wasmtime">wasmtime</a> 对于多语言的支持还不足，云厂商例如 Cloudflare 与 AWS Lambda@Edge 都不是原生支持 WASM，WASM 的执行性能也可能比不上 Google 的 v8 JavaScript 引擎。</p>
<p>当我们也看到了一些希望：Go 官方也许会<a href="https://github.com/golang/go/issues/31105">支持 WASI</a>、APISIX 准备<a href="https://github.com/apache/apisix/issues/157">使用 Wamser 作为 WASM 运行时</a>。</p>
<p>我当前在进行的另一个项目也通过在浏览器中加载 WASM 实现 X.509 证书解析、签名与 ACME 申请证书，该项目还会使用 Serverless 技术进行流量代理，不过这个坑何时能填完就没有人知道了 💀。</p>
<h2>1. Krustlet 调度 WASM</h2>
<blockquote>
<p>Krustlet 介绍：<a href="https://www.infoq.cn/article/oumc77mjsl67m39lqgtg">使用 Rust 开发的 kubelet，用于运行 WASM 工作负载</a></p>
</blockquote>
<p>概述：Krustlet 的工作方式类似于 Kubelet，是在 K8s 集群工作节点上运行的后台程序，负责上报节点状态以及运行工作负载（WASM）。</p>
<p>目前不支持 CNI 网络。</p>
<h3>1.1. 部署安装</h3>
<h4>1.1.1. 测试环境</h4>
<ul>
<li>阿里云测试集群 - <code>192.168.33.161</code> 机器（2c 8g）</li>
</ul>
<h4>1.1.2. 安装 Krustlet</h4>
<pre><code class="language-bash">#!/bin/bash

wget https://krustlet.blob.core.windows.net/releases/krustlet-v0.7.0-linux-amd64.tar.gz -O /tmp/krustlet.tar.gz
tar zxvf /tmp/krustlet.tar.gz &#x26;&#x26; mv krustlet-wasi /usr/local/bin/
</code></pre>
<h4>1.1.3. 节点初始化</h4>
<blockquote>
<p>根据官方文档进行节点初始化: <a href="https://docs.krustlet.dev/intro/quickstart/">quickstart</a>。</p>
</blockquote>
<p>步骤：</p>
<ol>
<li>
<p>节点上安装 Kubectl 并配置有在 <code>kube-system</code> 下创建 CSR 资源的凭证</p>
</li>
<li>
<p>执行初始化脚本</p>
<pre><code class="language-bash">bash &#x3C;(curl https://raw.githubusercontent.com/deislabs/krustlet/master/docs/howto/assets/bootstrap.sh)
</code></pre>
</li>
<li>
<p>创建 Systemd 文件 <code>/etc/systemd/system/krustlet.service</code></p>
<pre><code class="language-bash">[Unit]
Description=Krustlet, a kubelet implementation for running WASM

[Service]
Restart=on-failure
RestartSec=5s
Environment=KUBECONFIG=/root/.kube/config
ExecStart=/usr/local/bin/krustlet-wasi
User=root
Group=root

[Install]
WantedBy=multi-user.target
</code></pre>
<pre><code class="language-bash">systemctl daemon-reload
systemctl enable krustlet.service
systemctl start krustlet.service
</code></pre>
</li>
<li>
<p>审核 CSR 申请</p>
<pre><code class="language-bash">kubectl certificate approve ${HOSTNAME}-tls
</code></pre>
</li>
</ol>
<h4>1.1.4. 节点状态</h4>
<p><img src="/images/2021-09-01-18.png" alt="等待手动 Approve"></p>
<p><img src="/images/2021-09-01-14.png" alt="程序正常启动"></p>
<p><img src="/images/2021-09-01-15.png" alt="Krustlet 节点已加入集群"></p>
<ul>
<li>
<p>Krustlet 节点详情 <code>kubectl describe node ${HOSTNAME}</code></p>
<pre><code class="language-bash">Name:               izuf6cc5ecqwtuhm1p2rcaz
Roles:              &#x3C;none>
Labels:             beta.kubernetes.io/arch=wasm32-wasi
                    beta.kubernetes.io/os=wasm32-wasi
                    kubernetes.io/arch=wasm32-wasi
                    kubernetes.io/hostname=iZuf6cc5ecqwtuhm1p2rcaZ
                    kubernetes.io/os=wasm32-wasi
                    type=krustlet
Annotations:        node.alpha.kubernetes.io/ttl: 0
                    volumes.kubernetes.io/controller-managed-attach-detach: true
CreationTimestamp:  Thu, 08 Jul 2021 14:45:26 +0800
Taints:             kubernetes.io/arch=wasm32-wasi:NoExecute
                    kubernetes.io/arch=wasm32-wasi:NoSchedule
Unschedulable:      false
Lease:
  HolderIdentity:  izuf6cc5ecqwtuhm1p2rcaz
  AcquireTime:     Thu, 08 Jul 2021 14:49:37 +0800
  RenewTime:       Thu, 08 Jul 2021 14:49:37 +0800
Conditions:
  Type        Status  LastHeartbeatTime                 LastTransitionTime                Reason                     Message
  ----        ------  -----------------                 ------------------                ------                     -------
  Ready       True    Thu, 08 Jul 2021 14:49:37 +0800   Thu, 08 Jul 2021 14:45:26 +0800   KubeletReady               kubelet is posting ready status
  OutOfDisk   False   Thu, 08 Jul 2021 14:45:26 +0800   Thu, 08 Jul 2021 14:45:26 +0800   KubeletHasSufficientDisk   kubelet has sufficient disk space available
Addresses:
  InternalIP:  192.168.33.161
  Hostname:    iZuf6cc5ecqwtuhm1p2rcaZ
Capacity:
  cpu:                4
  ephemeral-storage:  61255492Ki
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             4032800Ki
  pods:               110
Allocatable:
  cpu:                4
  ephemeral-storage:  61255492Ki
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             4032800Ki
  pods:               110
System Info:
  Machine ID:
  System UUID:
  Boot ID:
  Kernel Version:
  OS Image:
  Operating System:           linux
  Architecture:               wasm-wasi
  Container Runtime Version:  mvp
  Kubelet Version:            0.7.0
  Kube-Proxy Version:         v1.17.0
PodCIDR:                      10.244.0.0/24
PodCIDRs:                     10.244.0.0/24
Non-terminated Pods:          (3 in total)
  Namespace                   Name                   CPU Requests  CPU Limits  Memory Requests  Memory Limits  Age
  ---------                   ----                   ------------  ----------  ---------------  -------------  ---
  kruise-system               kruise-daemon-v9nfh    0 (0%)        50m (1%)    0 (0%)           64Mi (1%)      4m17s
  kube-system                 calico-node-m4d67      150m (3%)     300m (7%)   64M (1%)         500M (12%)     4m17s
  kube-system                 nodelocaldns-k5kd2     100m (2%)     0 (0%)      70Mi (1%)        170Mi (4%)     4m17s
Allocated resources:
  (Total limits may be over 100 percent, i.e., overcommitted.)
  Resource           Requests        Limits
  --------           --------        ------
  cpu                250m (6%)       350m (8%)
  memory             137400320 (3%)  745366784 (18%)
  ephemeral-storage  0 (0%)          0 (0%)
  hugepages-1Gi      0 (0%)          0 (0%)
  hugepages-2Mi      0 (0%)          0 (0%)
Events:              &#x3C;none>
</code></pre>
</li>
</ul>
<p>节点带有两个污点：</p>
<pre><code class="language-bash">Taints:             kubernetes.io/arch=wasm32-wasi:NoExecute
                    kubernetes.io/arch=wasm32-wasi:NoSchedule
</code></pre>
<h3>1.2. WASM OCI</h3>
<p>Krustlet 使用 <a href="https://github.com/engineerd/wasm-to-oci">wasm-to-oci</a> 打包 WASM 编译后的二进制文件到镜像仓库。</p>
<h4>1.2.1. 推送镜像</h4>
<p>安装 wasm-to-oci CLI</p>
<pre><code class="language-bash">wget https://github.com/engineerd/wasm-to-oci/releases/download/v0.1.2/linux-amd64-wasm-to-oci -O /usr/local/bin/wasm-to-oci \
&#x26;&#x26; chmod +x /usr/local/bin/wasm-to-oci
</code></pre>
<ul>
<li>
<p><code>wasm-to-oci</code> Usage</p>
<pre><code class="language-bash">Usage:
  wasm-to-oci [command]

Available Commands:
  help        Help about any command
  pull        Pulls a WASM module from an OCI registry
  push        Pushes a WASM module from an OCI registry

Flags:
  -d, --dir string         Directory where the trust data is persisted to (default "/root/.wasm-to-oci")
  -h, --help               help for wasm-to-oci
      --insecure           allow connections to SSL registry without certs
      --log string         Set the logging level ("debug"|"info"|"warn"|"error"|"fatal") (default "info")
      --server string      The trust server used (default "https://notary.docker.io")
  -t, --timeout string     Timeout for the trust server (default "5s")
      --tlscacert string   Trust certs signed only by this CA
      --use-http           use plain http and not https
</code></pre>
</li>
</ul>
<p>打包示例 WASM（二进制编译后的文件）</p>
<pre><code class="language-bash">wget https://github.com/engineerd/wasm-to-oci/raw/master/testdata/hello.wasm
wasm-to-oci push hello.wasm harbor.domain.dev/bifrost/hello-wasm:v1
</code></pre>
<blockquote>
<p>Docker 需要有 Registry 的凭证 <code>~/.docker/config.json</code></p>
</blockquote>
<p>Push 输出：</p>
<pre><code class="language-bash">INFO[0001] Pushed: harbor.domain.dev/bifrost/hello-wasm:v1
INFO[0001] Size: 1624962
INFO[0001] Digest: sha256:a01f32cc647abe49bb34727cc2c520e6e304e3049d669f53e2d30d49ee2ed9c7
</code></pre>
<p>wasm-oci 使用了自定义的 OCI Layer，属于非标准类型。</p>
<blockquote>
<p><a href="https://radu-matei.com/blog/wasm-oci-tuf/">Securely distributing and signing WebAssembly modules using OCI and TUF</a></p>
</blockquote>
<pre><code class="language-json">{
  "schemaVersion": 2,
  "config": {
    "mediaType": "application/vnd.wasm.config.v1+json",
    "digest": "sha256:44136fa355b3678a1146ad16f7e8649e94fb4fc21fe77e8310c060f61caaff8a",
    "size": 2
  },
  "layers": [
    {
      "mediaType": "application/vnd.wasm.content.layer.v1+wasm",
      "digest": "sha256:4c7915b4c1f9b0c13f962998e4199ceb00db39a4a7fa4554f40ae0bed83d9510",
      "size": 1624962
    }
  ]
}
</code></pre>
<h4>1.2.2. 拉取镜像</h4>
<p>由于是非标准格式的 OCI 镜像，直接使用 Docker CLI 拉取会出错：</p>
<pre><code class="language-bash">v1: Pulling from bifrost/hello-wasm
4c7915b4c1f9: Pulling fs layer
invalid rootfs in image configuration
</code></pre>
<h4>1.2.3. WASM module 与容器区别</h4>
<p><a href="https://github.com/deislabs/krustlet/issues/624#issuecomment-855607557">Krustlet-tutorial pod get stuck in init:regitered status · Issue #624 · deislabs/krustlet</a></p>
<ul>
<li>WASM OCI 不是 Docker 容器</li>
<li>WASM OCI 不能使用 Docker pull</li>
</ul>
<h3>1.3. WASM Pod 调度</h3>
<p>WASM 调度的最小单元是 Pod，Pod 定义中必须包含 WASM 节点的 tolerations。</p>
<h4>1.3.1. Pod 调度</h4>
<p>示例 Pod：</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: wasm-hello
spec:
  containers:
    - name: wasm-hello
      image: harbor.domain.dev/bifrost/hello-wasm:v1
  tolerations:
    - key: "kubernetes.io/arch"
      operator: "Equal"
      value: "wasm32-wasi"
      effect: "NoExecute"
    - key: "kubernetes.io/arch"
      operator: "Equal"
      value: "wasm32-wasi"
      effect: "NoSchedule"
</code></pre>
<pre><code class="language-bash">> k apply -f wasm-hello.yaml
pod/wasm-hello created
</code></pre>
<ul>
<li>
<p>小插曲</p>
<p>试验过程中发现使用 wasm-to-oci 推送镜像到自建的 Harbor 镜像仓库后，拉取镜像时会报错。</p>
<p><a href="https://github.com/deislabs/krustlet/issues/624">Krustlet-tutorial pod get stuck in init:regitered status · Issue #624 · deislabs/krustlet</a></p>
<p>关联到一个 Issue，部分 Registry 会无法拉取镜像，报错：</p>
<pre><code class="language-bash">krustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG hyper::proto::h1::conn] incoming body is content-length (950 bytes)
krustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG hyper::proto::h1::conn] incoming body completed
krustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG hyper::client::pool] pooling idle connection for ("https", harbor....)
krustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG reqwest::async_impl::client] response '200 OK' for https://harbor..../service/token?scope=repository%3Abifrost%2Fhello-wasm%3Apull&#x26;service=harbor-registry
krustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG oci_distribution::client] Received response from auth request: {"token":"...","access_token":"","expires_in":1800,"issued_at":"2021-07-08T08:31:46Z"}
krustlet-wasi[20706]: [2021-07-08T08:31:46Z ERROR kubelet::state::common::image_pull] Failed to decode registry token from auth request
krustlet-wasi[20706]:
krustlet-wasi[20706]:     Caused by:
krustlet-wasi[20706]:         duplicate field `token` at line 1 column 1129
krustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG krator::state] State::status
krustlet-wasi[20706]: [2021-07-08T08:31:46Z DEBUG krator::state] Applying status patch to object. name=wasm-hello patch={"metadata":{"resourceVersion":""},"status":{"phase":"Pending","message":"ImagePullBackoff","reason":"ImagePullBackoff"}}
</code></pre>
<p>将镜像替换为 <a href="http://webassembly.azurecr.io/hello-world-wasi-rust:v0.1.0"><code>webassembly.azurecr.io/hello-world-wasi-rust:v0.1.0</code></a> 可正常运行。</p>
</li>
</ul>
<h4>1.3.2. Pod 运行时</h4>
<p>查看 Pod 运行状态：</p>
<pre><code class="language-bash">> k get pod -n ns-msp | grep wasm
wasm-hello        0/1     ExitCode:0         0          13m
</code></pre>
<p>Pod 被调度后立刻被执行，返回 ExitCode 0。</p>
<pre><code class="language-bash">> k logs -n ns-msp -f wasm-hello
hello from stdout!
hello from stderr!
Args are: []
</code></pre>
<p>kubectl 查看与运行日志。</p>
<ul>
<li>
<p>Pod YAML</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: "2021-07-08T08:37:39Z"
  name: wasm-hello
  namespace: ns-msp
  resourceVersion: "543645433"
  selfLink: /api/v1/namespaces/ns-msp/pods/wasm-hello
  uid: 09f74071-fd90-45be-be7d-466ef211043a
spec:
  containers:
  - image: webassembly.azurecr.io/hello-world-wasi-rust:v0.1.0
    imagePullPolicy: IfNotPresent
    name: wasm-hello
    resources: {}
    terminationMessagePath: /dev/termination-log
    terminationMessagePolicy: File
    volumeMounts:
    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount
      name: default-token-h8q2z
      readOnly: true
  dnsPolicy: ClusterFirst
  enableServiceLinks: true
  nodeName: izuf6cc5ecqwtuhm1p2rcaz
  priority: 0
  restartPolicy: Always
  schedulerName: default-scheduler
  securityContext: {}
  serviceAccount: default
  serviceAccountName: default
  terminationGracePeriodSeconds: 30
  tolerations:
  - effect: NoExecute
    key: kubernetes.io/arch
    operator: Equal
    value: wasm32-wasi
  - effect: NoSchedule
    key: kubernetes.io/arch
    operator: Equal
    value: wasm32-wasi
  - effect: NoExecute
    key: node.kubernetes.io/not-ready
    operator: Exists
    tolerationSeconds: 300
  - effect: NoExecute
    key: node.kubernetes.io/unreachable
    operator: Exists
    tolerationSeconds: 300
  volumes:
  - name: default-token-h8q2z
    secret:
      defaultMode: 420
      secretName: default-token-h8q2z
status:
  conditions:
  - lastProbeTime: null
    lastTransitionTime: "2021-07-08T08:37:39Z"
    status: "True"
    type: PodScheduled
  containerStatuses:
  - image: ""
    imageID: ""
    lastState: {}
    name: wasm-hello
    ready: false
    restartCount: 0
    started: true
    state:
      terminated:
        exitCode: 0
        finishedAt: "2021-07-08T08:37:52Z"
        message: Module run completed
        startedAt: null
  message: Completed
  phase: Succeeded
  qosClass: BestEffort
  reason: Completed
</code></pre>
</li>
</ul>
<h2>2. Containerd 插件调度 WASM</h2>
<blockquote>
<p>containerd-wasm 可以让 containerd 支持 WASM container，并且可以利用 Kubernetes 集群管理和调度 WASM container。</p>
</blockquote>
<blockquote>
<p>注：这个项目更多是概念验证，进程管理、资源限制，性能优化等的细节并没未完整实现。</p>
</blockquote>
<p><img src="/images/2021-09-01-16.png" alt=""></p>
<p>“container-shim-wasm-v1” 作为 Containerd 的插件，利用 wasmer 作为 WASM 应用运行时环境，同时将其注册为 K8s 的一个 RuntimeClass ，利用 K8s 调度 WASM。</p>
<h3>2.1. 部署安装</h3>
<blockquote>
<p>使用项目：<a href="https://github.com/dippynark/containerd-shim-wasm">https://github.com/dippynark/containerd-shim-wasm</a></p>
</blockquote>
<p>验证需要一个使用 Containerd 的 K8s 集群环境，使用 Kind 部署集群。</p>
<pre><code class="language-yaml">kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  extraMounts:
  - hostPath: config/containerd.toml
    containerPath: /etc/containerd/config.toml
  - hostPath: bin/containerd-shim-wasm-v1
    containerPath: /usr/local/bin/containerd-shim-wasm-v1
  - hostPath: bin/wasmer
    containerPath: /usr/local/bin/wasmer
</code></pre>
<p>Containerd 的配置中配置 wasm Runtime：</p>
<pre><code class="language-yaml"># Custom configuration
# https://github.com/containerd/cri/blob/master/docs/config.md
[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.wasm]
  runtime_type = "io.containerd.wasm.v1"
</code></pre>
<blockquote>
<p>参考文章：<a href="https://www.kubernetes.org.cn/7185.html">理解 RuntimeClass 与使用多容器运行时</a></p>
</blockquote>
<p><img src="/images/2021-09-01-17.png" alt=""></p>
<p>Containerd 的 Runtime 会对应到 K8s 的 RuntimeClass。</p>
<pre><code class="language-yaml">apiVersion: node.k8s.io/v1beta1
kind: RuntimeClass
metadata:
  name: wasm
handler: wasm
</code></pre>
<p>注册 K8s RuntimeClass 资源。</p>
<h3>2.2. WASM Runtime 调度</h3>
<h4>2.2.1. 编译 WASM Module</h4>
<p>使用 target 为 <code>wasi/wasm</code> 进行编译，最终会使用 <code>wasm32-wasi-clang</code> 进行编译。</p>
<pre><code class="language-docker">FROM --platform=$BUILDPLATFORM tonistiigi/xx:llvm AS builder
ARG TARGETPLATFORM
WORKDIR /src
COPY hello-wasm/main.c .
RUN clang -static -o /hello-wasm main.c

FROM scratch
COPY --from=builder /hello-wasm .
CMD ["/hello-wasm"]
</code></pre>
<p>虽然 Dockerfile 里写了 <code>CMD</code> ，但是如果直接在操作系统上执行命令，会报错：</p>
<pre><code class="language-bash">> ./bin/hello-wasm
zsh: exec format error: ./bin/hello-wasm
</code></pre>
<p>推测 <a href="https://github.com/dmcgowan/containerd-wasm"><code>github.com/dmcgowan/containerd-wasm</code></a> 库实际上会解析 Container 文件系统，提取出要执行的 WASM module，最后调用运行时（wasmtime/wasmer）运行 WASM。</p>
<p>我们实际使用任意的 WASM module 打包进 Docker 容器中：</p>
<pre><code class="language-docker">FROM scratch
COPY ./hello.wasm .
CMD ["/hello.wasm"]
</code></pre>
<h4>2.2.2. 调度 Pod</h4>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-wasm
spec:
  selector:
    matchLabels:
      app: hello-wasm
  template:
    metadata:
      labels:
        app: hello-wasm
    spec:
      runtimeClassName: wasm
      containers:
      - name: hello-wasm
        ## WASM 编译打包的 Docker 镜像
        image: harbor.domain.dev/bifrost/hello-wasm2:v1
        imagePullPolicy: Always
</code></pre>
<p>Pod 运行状态：</p>
<pre><code class="language-yaml">default  hello-wasm-86db957848-cgvdj     0/1     Completed     0      7s
</code></pre>
<p>Pod 输出日志：</p>
<pre><code class="language-bash">> kubectl logs hello-wasm-86db957848-cgvdj
Hello from WebAssembly!
</code></pre>
<h3>2.3. 对比 Krustlet</h3>
<blockquote>
<p>One difficulty with this shim implementation is that the shim API assumes a container runtime (as that's what it was designed for), but this doens't align as well with running WebAssmebly modules (for example currently you can't exec into a WebAssmebly module as you would a container). The Krustlet project implements a Kubelet replacement that treats wasi/wasm modules as first class citizens.</p>
</blockquote>
<p>作为 Containerd 插件的 WASM Runtime 实现起来较为简单，同时代码中有大量的 TODO。</p>
<p>但是参照其实现的模式，公司内部也可自行实行一套 WASM 模块分发机制，运行时只需加载对应模块，调用（wasmtime/wasmer）运行即可。</p>
<section data-footnotes class="footnotes"><h2 class="sr-only" id="footnote-label">Footnotes</h2>
<ol>
<li id="user-content-fn-1">
<p>Webassembly 在各类文章中被捧上天，但是截至 2021 年它的使用场景还十分局限。 <a href="#user-content-fnref-1" data-footnote-backref="" aria-label="Back to reference 1" class="data-footnote-backref">↩</a></p>
</li>
</ol>
</section>4:["$","article",null,{"dangerouslySetInnerHTML":{"__html":"$c"}}]
