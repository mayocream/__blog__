<!doctype html><html lang=zh>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=hugo-theme content=" 0.8.0">
<link rel=icon type=image/png sizes=32x32 href=/>
<link rel=icon type=image/x-icon href=/>
<link rel=apple-touch-icon href=/>
<link rel=canonical href=/2020/12/hugo-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/>
<link rel=preload as=style href="/bundle.css?v=1631904279" media=all>
<link rel=stylesheet href="/bundle.css?v=1631904279" media=all>
<style>.cdata pre{background-color:#1f2937;color:#e5e7eb}.cdata :not(pre)>code{background-color:#f3f4f6;color:#7c3aed}.chroma .err{background-color:#991b1b;color:#fecaca}.chroma .hl{background-color:#374151}.chroma .ln{color:#9ca3af}.chroma .k,.chroma .kc,.chroma .kd,.chroma .kn,.chroma .kp,.chroma .kr{color:#60a5fa}.chroma .kt{color:#a78bfa}.chroma .na,.chroma .nb{color:#fbbf24}.chroma .nc{color:#f87171}.chroma .no{color:#34d399}.chroma .nd{color:#f87171}.chroma .ne{color:#f87171}.chroma .nf{color:#fbbf24}.chroma .nt{color:#f87171}.chroma .l{color:#a78bfa}.chroma .dl,.chroma .ld,.chroma .s,.chroma .s2,.chroma .sa,.chroma .sb,.chroma .sc,.chroma .sd{color:#34d399}.chroma .se{color:#9ca3af}.chroma .s1,.chroma .sh,.chroma .si,.chroma .sr,.chroma .ss,.chroma .sx{color:#34d399}.chroma .il,.chroma .m,.chroma .mb,.chroma .mf,.chroma .mh,.chroma .mi,.chroma .mo{color:#a78bfa}.chroma .o,.chroma .ow{color:#93c5fd}.chroma .c,.chroma .c1,.chroma .ch,.chroma .cm,.chroma .cp,.chroma .cpf,.chroma .cs,.chroma .p{color:#9ca3af}.chroma .ge{font-style:italic}.chroma .gs{font-weight:700}</style>
<title>Hugo 源码阅读 : Mayo's Blog</title>
<meta property="og:title" content="Hugo 源码阅读">
<meta property="og:site_name" content="Mayo's Blog">
<meta property="og:url" content="/2020/12/hugo-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">
<link rel=image_src href=/>
<meta property="og:image" content="/">
<meta property="og:image:width" content>
<meta property="og:image:height" content>
<meta property="og:type" content="article">
<meta property="og:locale" content="zh">
<meta property="og:description" content="Hugo 源码阅读 WIP 一、概述 1.1 目录结构 … 二、程序流程 2.1 流程定义 2.1.1 错误状态码 func main() { resp := commands.Execute(os.Args[1:]) if resp.Err != nil { if resp.IsUserError() { resp.Cmd.Println(&amp;quot;&amp;quot;) resp.Cmd.Println(resp.Cmd.UsageString()) } os.Exit(-1) } } os.Exit(-1) 程序的退出状态码不在 0~255 之间，会自">
<meta name=description content="Hugo 源码阅读 WIP 一、概述 1.1 目录结构 … 二、程序流程 2.1 流程定义 2.1.1 错误状态码 func main() { resp := commands.Execute(os.Args[1:]) if resp.Err != nil { if resp.IsUserError() { resp.Cmd.Println(&amp;quot;&amp;quot;) resp.Cmd.Println(resp.Cmd.UsageString()) } os.Exit(-1) } } os.Exit(-1) 程序的退出状态码不在 0~255 之间，会自">
<meta property="og:updated_time" content="2020-12-10T00:00:00Z">
<meta property="fb:app_id" content>
<meta name=author content="Unknown">
<meta property="article:author" content="/">
<meta property="article:published_time" content="2020-12-10T00:00:00Z">
<meta property="article:modified_time" content="2020-12-10T00:00:00Z">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"Hugo 源码阅读","alternativeHeadline":"Hugo 源码阅读 WIP 一、概述 1.1 目录结构 … 二、程序流程 2.1 流程定义 2.1.1 错误状态码 func main() { resp := commands.Execute(os.Args[1:]) if resp.Err != nil { if resp.IsUserError() { resp.Cmd.Println(\u0026quot;\u0026quot;) resp.Cmd.Println(resp.Cmd.UsageString()) } os.Exit(-1) } } os.Exit(-1) 程序的退出状态码不在 0~255 之间，会自","url":"/2020/12/hugo-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/","image":"/","mainEntityOfPage":{"@type":"WebPage","@id":"/2020/12/hugo-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/"},"description":"Hugo 源码阅读 WIP 一、概述 1.1 目录结构 … 二、程序流程 2.1 流程定义 2.1.1 错误状态码 func main() { resp := commands.Execute(os.Args[1:]) if resp.Err != nil { if resp.IsUserError() { resp.Cmd.Println(\u0026quot;\u0026quot;) resp.Cmd.Println(resp.Cmd.UsageString()) } os.Exit(-1) } } os.Exit(-1) 程序的退出状态码不在 0~255 之间，会自","author":{"@type":"Person","name":"Unknown"},"publisher":{"@type":"Organization","name":"Mayo's Blog","logo":{"@type":"ImageObject","url":"/"}},"datePublished":"2020-12-10T00:00:00Z","dateModified":"2020-12-10T00:00:00Z","articleBody":"\u003ch1 id=\"hugo-源码阅读\"\u003eHugo 源码阅读\u003c/h1\u003e\n\u003cblockquote\u003e\n\u003cp\u003eWIP\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2 id=\"一概述\"\u003e一、概述\u003c/h2\u003e\n\u003ch3 id=\"11-目录结构\"\u003e1.1 目录结构\u003c/h3\u003e\n\u003cp\u003e\u0026hellip;\u003c/p\u003e\n\u003ch2 id=\"二程序流程\"\u003e二、程序流程\u003c/h2\u003e\n\u003ch3 id=\"21-流程定义\"\u003e2.1 流程定义\u003c/h3\u003e\n\u003ch4 id=\"211-错误状态码\"\u003e2.1.1 错误状态码\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\t\u003cspan style=\"color:#a6e22e\"\u003eresp\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecommands\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eExecute\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eos\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eArgs\u003c/span\u003e[\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e:])\n\n\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eresp\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eErr\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e {\n\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eresp\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eIsUserError\u003c/span\u003e() {\n\t\t\t\u003cspan style=\"color:#a6e22e\"\u003eresp\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eCmd\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ePrintln\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e)\n\t\t\t\u003cspan style=\"color:#a6e22e\"\u003eresp\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eCmd\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ePrintln\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eresp\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eCmd\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eUsageString\u003c/span\u003e())\n\t\t}\n\t\t\u003cspan style=\"color:#a6e22e\"\u003eos\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eExit\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)\n\t}\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003ccode\u003eos.Exit(-1)\u003c/code\u003e 程序的退出状态码不在 0~255 之间，会自动做转换，转换的规则如下\u003c!-- raw HTML omitted --\u003e[1]\u003c!-- raw HTML omitted --\u003e：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e当指定的退出时状态码为负数:\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003e256 - (|code| % 256)\n\u003c/code\u003e\u003c/pre\u003e\u003cul\u003e\n\u003cli\u003e当指定的退出时状态码为正数:\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003ecode % 256\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e由此程序退出的状态码为 255。\u003c/p\u003e\n\u003ch4 id=\"212-cli-命令\"\u003e2.1.2 CLI 命令\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"color:#75715e\"\u003e// commands/commands.go\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ecommandsBuilder\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003eaddAll\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ecommandsBuilder\u003c/span\u003e {\n   \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eaddCommands\u003c/span\u003e(\n      \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003enewServerCmd\u003c/span\u003e(),\n      \u003cspan style=\"color:#a6e22e\"\u003enewVersionCmd\u003c/span\u003e(),\n      \u003cspan style=\"color:#a6e22e\"\u003enewEnvCmd\u003c/span\u003e(),\n      \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003enewConfigCmd\u003c/span\u003e(),\n      \u003cspan style=\"color:#a6e22e\"\u003enewCheckCmd\u003c/span\u003e(),\n      \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003enewDeployCmd\u003c/span\u003e(),\n      \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003enewConvertCmd\u003c/span\u003e(),\n      \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003enewNewCmd\u003c/span\u003e(),\n      \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003enewListCmd\u003c/span\u003e(),\n      \u003cspan style=\"color:#a6e22e\"\u003enewImportCmd\u003c/span\u003e(),\n      \u003cspan style=\"color:#a6e22e\"\u003enewGenCmd\u003c/span\u003e(),\n      \u003cspan style=\"color:#a6e22e\"\u003ecreateReleaser\u003c/span\u003e(),\n      \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003enewModCmd\u003c/span\u003e(),\n   )\n\n   \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e所有的 cmd handler 继承自 basecmd，实现了 cmder 接口：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"color:#75715e\"\u003e// commands/helpers.go\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003etype\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecmder\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003einterface\u003c/span\u003e {\n\t\u003cspan style=\"color:#a6e22e\"\u003eflagsToConfig\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ecfg\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003econfig\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eProvider\u003c/span\u003e)\n\t\u003cspan style=\"color:#a6e22e\"\u003egetCommand\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ecobra\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eCommand\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\n\u003cfigure class=\"image\"\u003e\n  \u003cimg src=\"/2020/12/hugo-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/images/hugo-impl.png\" alt=\"\" loading=\"lazy\" /\u003e\n  \n\u003c/figure\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"color:#75715e\"\u003e// commands/commands.go\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ecommandsBuilder\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003eaddAll\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ecommandsBuilder\u003c/span\u003e {\n\t\u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eaddCommands\u003c/span\u003e(\n\t\t\u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003enewServerCmd\u003c/span\u003e(),\n\t\t\u003cspan style=\"color:#a6e22e\"\u003enewVersionCmd\u003c/span\u003e(),\n\t\t\u003cspan style=\"color:#a6e22e\"\u003enewEnvCmd\u003c/span\u003e(),\n\t\t\u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003enewConfigCmd\u003c/span\u003e(),\n\t\t\u003cspan style=\"color:#a6e22e\"\u003enewCheckCmd\u003c/span\u003e(),\n\t\t\u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003enewDeployCmd\u003c/span\u003e(),\n\t\t\u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003enewConvertCmd\u003c/span\u003e(),\n\t\t\u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003enewNewCmd\u003c/span\u003e(),\n\t\t\u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003enewListCmd\u003c/span\u003e(),\n\t\t\u003cspan style=\"color:#a6e22e\"\u003enewImportCmd\u003c/span\u003e(),\n\t\t\u003cspan style=\"color:#a6e22e\"\u003enewGenCmd\u003c/span\u003e(),\n\t\t\u003cspan style=\"color:#a6e22e\"\u003ecreateReleaser\u003c/span\u003e(),\n\t\t\u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003enewModCmd\u003c/span\u003e(),\n\t)\n\n\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e\n}\n\n\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ecommandsBuilder\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003ebuild\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ehugoCmd\u003c/span\u003e {\n\t\u003cspan style=\"color:#75715e\"\u003e// 添加主 hugo 命令\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#a6e22e\"\u003eh\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003enewHugoCmd\u003c/span\u003e()\n\t\u003cspan style=\"color:#75715e\"\u003e// 将命令数组添加进 cobra 的 Root Command 中, 作为子命令\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#a6e22e\"\u003eaddCommands\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eh\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003egetCommand\u003c/span\u003e(), \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ecommands\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e...\u003c/span\u003e)\n\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eh\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"22-渲染初始化\"\u003e2.2 渲染初始化\u003c/h3\u003e\n\u003cblockquote\u003e\n\u003cp\u003e执行 Hugo 命令时进行的初始化加载\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"color:#75715e\"\u003e// 创建 hugoCmd 封装块\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ecommandsBuilder\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003enewHugoCmd\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ehugoCmd\u003c/span\u003e {\n\t\u003cspan style=\"color:#a6e22e\"\u003ecc\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ehugoCmd\u003c/span\u003e{}\n\n\t\u003cspan style=\"color:#a6e22e\"\u003ecc\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ebaseBuilderCmd\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eb\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003enewBuilderCmd\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ecobra\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eCommand\u003c/span\u003e{\n\t\t\u003cspan style=\"color:#a6e22e\"\u003eUse\u003c/span\u003e:   \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;hugo\u0026#34;\u003c/span\u003e,\n\t\t\u003cspan style=\"color:#a6e22e\"\u003eShort\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;hugo builds your site\u0026#34;\u003c/span\u003e,\n\t\t\u003cspan style=\"color:#a6e22e\"\u003eLong\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e`hugo is the main command, used to build your Hugo site.\n\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\n\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003eHugo is a Fast and Flexible Static Site Generator\n\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003ebuilt with love by spf13 and friends in Go.\n\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\n\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003eComplete documentation is available at http://gohugo.io/.`\u003c/span\u003e,\n\n\t\t\u003cspan style=\"color:#75715e\"\u003e// 执行渲染操作\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#a6e22e\"\u003eRunE\u003c/span\u003e: \u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ecmd\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ecobra\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eCommand\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eargs\u003c/span\u003e []\u003cspan style=\"color:#66d9ef\"\u003estring\u003c/span\u003e) \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e {\n\t\t\t\u003cspan style=\"color:#75715e\"\u003e// 记录全局操作耗时\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\t\u003cspan style=\"color:#66d9ef\"\u003edefer\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecc\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003etimeTrack\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eNow\u003c/span\u003e(), \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Total\u0026#34;\u003c/span\u003e)\n\t\t\t\u003cspan style=\"color:#a6e22e\"\u003ecfgInit\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ecommandeer\u003c/span\u003e) \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e {\n\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecc\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ebuildWatch\u003c/span\u003e {\n\t\t\t\t\t\u003cspan style=\"color:#75715e\"\u003e// 如果开启了 watch 模式则关闭动态重载\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eSet\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;disableLiveReload\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e)\n\t\t\t\t}\n\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e\n\t\t\t}\n\n\t\t\t\u003cspan style=\"color:#75715e\"\u003e// 初始化配置\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\t\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003einitializeConfig\u003c/span\u003e(\u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ecc\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ebuildWatch\u003c/span\u003e, \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ecc\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ehugoBuilderCommon\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ecc\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ecfgInit\u003c/span\u003e)\n\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e {\n\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e\n\t\t\t}\n\t\t\t\u003cspan style=\"color:#a6e22e\"\u003ecc\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e\n\n\t\t\t\u003cspan style=\"color:#75715e\"\u003e// 编译操作\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ebuild\u003c/span\u003e()\n\t\t},\n\t})\n   \n    \u003cspan style=\"color:#f92672\"\u003e...\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"221-配置文件加载\"\u003e2.2.1 配置文件加载\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"color:#75715e\"\u003e// hugolib/config.go\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\n\t\u003cspan style=\"color:#66d9ef\"\u003efor\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003e_\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003econfigDir\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003erange\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003econfigDirs\u003c/span\u003e {\n\t\t\u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eafero\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eWalk\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003esourceFs\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003econfigDir\u003c/span\u003e, \u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003epath\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003estring\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efi\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eos\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eFileInfo\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e) \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e {\n\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efi\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e||\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e {\n\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e\n\t\t\t}\n\n\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efi\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eIsDir\u003c/span\u003e() {\n\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003edirnames\u003c/span\u003e = append(\u003cspan style=\"color:#a6e22e\"\u003edirnames\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003epath\u003c/span\u003e)\n\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e\n\t\t\t}\n\n\t\t\t\u003cspan style=\"color:#75715e\"\u003e// 检查文件后缀是否是支持的格式\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e !\u003cspan style=\"color:#a6e22e\"\u003econfig\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eIsValidConfigFilename\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003epath\u003c/span\u003e) {\n\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e\n\t\t\t}\n\n\t\t\t\u003cspan style=\"color:#75715e\"\u003e// 文件名, 移除文件后缀\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\t\u003cspan style=\"color:#a6e22e\"\u003ename\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ehelpers\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eFilename\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003efilepath\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eBase\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003epath\u003c/span\u003e))\n\n\t\t\t\u003cspan style=\"color:#75715e\"\u003e// 加载文件内容到 map\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\t\u003cspan style=\"color:#a6e22e\"\u003eitem\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emetadecoders\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eDefault\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eUnmarshalFileToMap\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003esourceFs\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003epath\u003c/span\u003e)\n\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e {\n\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003el\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ewrapFileError\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003epath\u003c/span\u003e)\n\t\t\t}\n\n\t\t\t\u003cspan style=\"color:#66d9ef\"\u003evar\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ekeyPath\u003c/span\u003e []\u003cspan style=\"color:#66d9ef\"\u003estring\u003c/span\u003e\n\n\t\t\t\u003cspan style=\"color:#75715e\"\u003e// 如果不是 hugo 的 config 文件\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ename\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;config\u0026#34;\u003c/span\u003e {\n\t\t\t\t\u003cspan style=\"color:#75715e\"\u003e// Can be params.jp, menus.en etc.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\t\t\u003cspan style=\"color:#75715e\"\u003e// 如果文件还有后缀, 可能是语言后缀\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003ename\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003elang\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ehelpers\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eFileAndExtNoDelimiter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ename\u003c/span\u003e)\n\n\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003ekeyPath\u003c/span\u003e = []\u003cspan style=\"color:#66d9ef\"\u003estring\u003c/span\u003e{\u003cspan style=\"color:#a6e22e\"\u003ename\u003c/span\u003e}\n\n\t\t\t\t\u003cspan style=\"color:#75715e\"\u003e// 如果语言后缀存在\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elang\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e {\n\t\t\t\t\t\u003cspan style=\"color:#75715e\"\u003e// 填充语言文件夹路径\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003ekeyPath\u003c/span\u003e = []\u003cspan style=\"color:#66d9ef\"\u003estring\u003c/span\u003e{\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;languages\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003elang\u003c/span\u003e}\n\t\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eswitch\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ename\u003c/span\u003e {\n\t\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;menu\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;menus\u0026#34;\u003c/span\u003e:\n\t\t\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003ekeyPath\u003c/span\u003e = append(\u003cspan style=\"color:#a6e22e\"\u003ekeyPath\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;menus\u0026#34;\u003c/span\u003e)\n\t\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;params\u0026#34;\u003c/span\u003e:\n\t\t\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003ekeyPath\u003c/span\u003e = append(\u003cspan style=\"color:#a6e22e\"\u003ekeyPath\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;params\u0026#34;\u003c/span\u003e)\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t\u003cspan style=\"color:#a6e22e\"\u003eroot\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eitem\u003c/span\u003e\n\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e len(\u003cspan style=\"color:#a6e22e\"\u003ekeyPath\u003c/span\u003e) \u0026gt; \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e {\n\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003eroot\u003c/span\u003e = make(\u003cspan style=\"color:#66d9ef\"\u003emap\u003c/span\u003e[\u003cspan style=\"color:#66d9ef\"\u003estring\u003c/span\u003e]\u003cspan style=\"color:#66d9ef\"\u003einterface\u003c/span\u003e{})\n\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003em\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eroot\u003c/span\u003e\n\n\t\t\t\t\u003cspan style=\"color:#75715e\"\u003e// 遍历形成层级关系\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\n\t\t\t\t\u003cspan style=\"color:#75715e\"\u003e// 遍历语言文件夹的路径\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\t\t\u003cspan style=\"color:#75715e\"\u003e// i 从 0 开始\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003efor\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ekey\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003erange\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ekeyPath\u003c/span\u003e {\n\t\t\t\t\t\u003cspan style=\"color:#75715e\"\u003e// 如果 i \u0026gt;= 最后一个元素的 index\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026gt;=\u003c/span\u003e len(\u003cspan style=\"color:#a6e22e\"\u003ekeyPath\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e {\n\t\t\t\t\t\t\u003cspan style=\"color:#75715e\"\u003e// 将文件内容填充到 key 下面\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003em\u003c/span\u003e[\u003cspan style=\"color:#a6e22e\"\u003ekey\u003c/span\u003e] = \u003cspan style=\"color:#a6e22e\"\u003eitem\u003c/span\u003e\n\t\t\t\t\t} \u003cspan style=\"color:#66d9ef\"\u003eelse\u003c/span\u003e {\n\t\t\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003enm\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e make(\u003cspan style=\"color:#66d9ef\"\u003emap\u003c/span\u003e[\u003cspan style=\"color:#66d9ef\"\u003estring\u003c/span\u003e]\u003cspan style=\"color:#66d9ef\"\u003einterface\u003c/span\u003e{})\n\t\t\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003em\u003c/span\u003e[\u003cspan style=\"color:#a6e22e\"\u003ekey\u003c/span\u003e] = \u003cspan style=\"color:#a6e22e\"\u003enm\u003c/span\u003e\n\t\t\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003em\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003enm\u003c/span\u003e\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t\u003cspan style=\"color:#75715e\"\u003e// Migrate menu =\u0026gt; menus etc.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\t\u003cspan style=\"color:#a6e22e\"\u003econfig\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eRenameKeys\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eroot\u003c/span\u003e)\n\n\t\t\t\u003cspan style=\"color:#75715e\"\u003e// 合并配置文件\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ev\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eMergeConfigMap\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eroot\u003c/span\u003e); \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e {\n\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003el\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ewrapFileError\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003epath\u003c/span\u003e)\n\t\t\t}\n\n\t\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e\n\t\t})\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e遍历配置文件夹、以及加载配置文件（yaml/toml/json 后缀）到 Map 中，使用 Viper 的 \u003ccode\u003eMergeConfigMap\u003c/code\u003e 载入配置，包含语言、菜单配置。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"color:#75715e\"\u003e// hugolib/hugo_sites.go\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e// 创建 sites 的配置\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecreateSitesFromConfig\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ecfg\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edeps\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eDepsCfg\u003c/span\u003e) ([]\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eSite\u003c/span\u003e, \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e) {\n\t\u003cspan style=\"color:#66d9ef\"\u003evar\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esites\u003c/span\u003e []\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eSite\u003c/span\u003e\n\n\t\u003cspan style=\"color:#75715e\"\u003e// 获取多语言配置\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#a6e22e\"\u003elanguages\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egetLanguages\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ecfg\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eCfg\u003c/span\u003e)\n\n\t\u003cspan style=\"color:#66d9ef\"\u003efor\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003e_\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003elang\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003erange\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elanguages\u003c/span\u003e {\n\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elang\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eDisabled\u003c/span\u003e {\n\t\t\t\u003cspan style=\"color:#66d9ef\"\u003econtinue\u003c/span\u003e\n\t\t}\n\t\t\u003cspan style=\"color:#66d9ef\"\u003evar\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003es\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eSite\u003c/span\u003e\n\t\t\u003cspan style=\"color:#66d9ef\"\u003evar\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e\n\t\t\u003cspan style=\"color:#a6e22e\"\u003ecfg\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eLanguage\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003elang\u003c/span\u003e\n\t\t\u003cspan style=\"color:#75715e\"\u003e// 为每个语言创建一个 site\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#a6e22e\"\u003es\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003enewSite\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ecfg\u003c/span\u003e)\n\n\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e {\n\t\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e\n\t\t}\n\n\t\t\u003cspan style=\"color:#a6e22e\"\u003esites\u003c/span\u003e = append(\u003cspan style=\"color:#a6e22e\"\u003esites\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003es\u003c/span\u003e)\n\t}\n\n\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esites\u003c/span\u003e, \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e为每个语言生成一个 Site。\u003c/p\u003e\n\u003ch4 id=\"222-内容加载\"\u003e2.2.2 内容加载\u003c/h4\u003e\n\u003cp\u003e注册回调函数:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"color:#75715e\"\u003e// hugolib/site.go\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e// 初始化\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003es\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eSite\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003eprepareInits\u003c/span\u003e() {\n\t\u003cspan style=\"color:#a6e22e\"\u003es\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003einit\u003c/span\u003e = \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003esiteInit\u003c/span\u003e{}\n\n\t\u003cspan style=\"color:#66d9ef\"\u003evar\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003einit\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elazy\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e\n\n\t\u003cspan style=\"color:#75715e\"\u003e// 回调函数\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#a6e22e\"\u003es\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003einit\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eprevNext\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003einit\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eBranch\u003c/span\u003e(\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e() (\u003cspan style=\"color:#66d9ef\"\u003einterface\u003c/span\u003e{}, \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e) {\n\t\t\u003cspan style=\"color:#75715e\"\u003e// 获取 pages\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#a6e22e\"\u003eregularPages\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003es\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eRegularPages\u003c/span\u003e()\n\t\t\u003cspan style=\"color:#66d9ef\"\u003efor\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ep\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003erange\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eregularPages\u003c/span\u003e {\n\t\t\t\u003cspan style=\"color:#a6e22e\"\u003enp\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eok\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ep\u003c/span\u003e.(\u003cspan style=\"color:#a6e22e\"\u003enextPrevProvider\u003c/span\u003e)\n\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e !\u003cspan style=\"color:#a6e22e\"\u003eok\u003c/span\u003e {\n\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003econtinue\u003c/span\u003e\n\t\t\t}\n\n\t\t\t\u003cspan style=\"color:#a6e22e\"\u003epos\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003enp\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003egetNextPrev\u003c/span\u003e()\n\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epos\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e {\n\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003econtinue\u003c/span\u003e\n\t\t\t}\n\n\t\t\t\u003cspan style=\"color:#a6e22e\"\u003epos\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003enextPage\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e\n\t\t\t\u003cspan style=\"color:#a6e22e\"\u003epos\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eprevPage\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e\n\n\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026gt; \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e {\n\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003epos\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003enextPage\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eregularPages\u003c/span\u003e[\u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e]\n\t\t\t}\n\n\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; len(\u003cspan style=\"color:#a6e22e\"\u003eregularPages\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e {\n\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003epos\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eprevPage\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eregularPages\u003c/span\u003e[\u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e]\n\t\t\t}\n\t\t}\n\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e, \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e\n\t})\n\n\t\u003cspan style=\"color:#a6e22e\"\u003es\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003einit\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eprevNextInSection\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003einit\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eBranch\u003c/span\u003e(\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e() (\u003cspan style=\"color:#66d9ef\"\u003einterface\u003c/span\u003e{}, \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e) {\n\t\t\u003cspan style=\"color:#66d9ef\"\u003evar\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esections\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epage\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ePages\u003c/span\u003e\n\t\t\u003cspan style=\"color:#a6e22e\"\u003es\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ehome\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003etreeRef\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003em\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ecollectSectionsRecursiveIncludingSelf\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003epageMapQuery\u003c/span\u003e{\u003cspan style=\"color:#a6e22e\"\u003ePrefix\u003c/span\u003e: \u003cspan style=\"color:#a6e22e\"\u003es\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ehome\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003etreeRef\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ekey\u003c/span\u003e}, \u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003en\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003econtentNode\u003c/span\u003e) {\n\t\t\t\u003cspan style=\"color:#a6e22e\"\u003esections\u003c/span\u003e = append(\u003cspan style=\"color:#a6e22e\"\u003esections\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003en\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ep\u003c/span\u003e)\n\t\t})\n\n\t\t\u003cspan style=\"color:#a6e22e\"\u003esetNextPrev\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003epas\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epage\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ePages\u003c/span\u003e) {\n\t\t\t\u003cspan style=\"color:#66d9ef\"\u003efor\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ep\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003erange\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epas\u003c/span\u003e {\n\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003enp\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eok\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ep\u003c/span\u003e.(\u003cspan style=\"color:#a6e22e\"\u003enextPrevInSectionProvider\u003c/span\u003e)\n\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e !\u003cspan style=\"color:#a6e22e\"\u003eok\u003c/span\u003e {\n\t\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003econtinue\u003c/span\u003e\n\t\t\t\t}\n\n\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003epos\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003enp\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003egetNextPrevInSection\u003c/span\u003e()\n\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epos\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e {\n\t\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003econtinue\u003c/span\u003e\n\t\t\t\t}\n\n\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003epos\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003enextPage\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e\n\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003epos\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eprevPage\u003c/span\u003e = \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e\n\n\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026gt; \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e {\n\t\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003epos\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003enextPage\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003epas\u003c/span\u003e[\u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e]\n\t\t\t\t}\n\n\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; len(\u003cspan style=\"color:#a6e22e\"\u003epas\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e {\n\t\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003epos\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eprevPage\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003epas\u003c/span\u003e[\u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e]\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t\u003cspan style=\"color:#66d9ef\"\u003efor\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003e_\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esect\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003erange\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esections\u003c/span\u003e {\n\t\t\t\u003cspan style=\"color:#a6e22e\"\u003etreeRef\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esect\u003c/span\u003e.(\u003cspan style=\"color:#a6e22e\"\u003etreeRefProvider\u003c/span\u003e).\u003cspan style=\"color:#a6e22e\"\u003egetTreeRef\u003c/span\u003e()\n\n\t\t\t\u003cspan style=\"color:#66d9ef\"\u003evar\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epas\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epage\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ePages\u003c/span\u003e\n\t\t\t\u003cspan style=\"color:#a6e22e\"\u003etreeRef\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003em\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ecollectPages\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003epageMapQuery\u003c/span\u003e{\u003cspan style=\"color:#a6e22e\"\u003ePrefix\u003c/span\u003e: \u003cspan style=\"color:#a6e22e\"\u003etreeRef\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ekey\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecmBranchSeparator\u003c/span\u003e}, \u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003econtentNode\u003c/span\u003e) {\n\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003epas\u003c/span\u003e = append(\u003cspan style=\"color:#a6e22e\"\u003epas\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ep\u003c/span\u003e)\n\t\t\t})\n\t\t\t\u003cspan style=\"color:#a6e22e\"\u003epage\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eSortByDefault\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003epas\u003c/span\u003e)\n\n\t\t\t\u003cspan style=\"color:#a6e22e\"\u003esetNextPrev\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003epas\u003c/span\u003e)\n\t\t}\n\n\t\t\u003cspan style=\"color:#75715e\"\u003e// The root section only goes one level down.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#a6e22e\"\u003etreeRef\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003es\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ehome\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003egetTreeRef\u003c/span\u003e()\n\n\t\t\u003cspan style=\"color:#66d9ef\"\u003evar\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epas\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epage\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ePages\u003c/span\u003e\n\t\t\u003cspan style=\"color:#a6e22e\"\u003etreeRef\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003em\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ecollectPages\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003epageMapQuery\u003c/span\u003e{\u003cspan style=\"color:#a6e22e\"\u003ePrefix\u003c/span\u003e: \u003cspan style=\"color:#a6e22e\"\u003etreeRef\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ekey\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecmBranchSeparator\u003c/span\u003e}, \u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003econtentNode\u003c/span\u003e) {\n\t\t\t\u003cspan style=\"color:#a6e22e\"\u003epas\u003c/span\u003e = append(\u003cspan style=\"color:#a6e22e\"\u003epas\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ep\u003c/span\u003e)\n\t\t})\n\t\t\u003cspan style=\"color:#a6e22e\"\u003epage\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eSortByDefault\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003epas\u003c/span\u003e)\n\n\t\t\u003cspan style=\"color:#a6e22e\"\u003esetNextPrev\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003epas\u003c/span\u003e)\n\n\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e, \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e\n\t})\n\n\t\u003cspan style=\"color:#a6e22e\"\u003es\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003einit\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003emenus\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003einit\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eBranch\u003c/span\u003e(\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e() (\u003cspan style=\"color:#66d9ef\"\u003einterface\u003c/span\u003e{}, \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e) {\n\t\t\u003cspan style=\"color:#a6e22e\"\u003es\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eassembleMenus\u003c/span\u003e()\n\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e, \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e\n\t})\n\n\t\u003cspan style=\"color:#a6e22e\"\u003es\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003einit\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003etaxonomies\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003einit\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eBranch\u003c/span\u003e(\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e() (\u003cspan style=\"color:#66d9ef\"\u003einterface\u003c/span\u003e{}, \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e) {\n\t\t\u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003es\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003epageMap\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eassembleTaxonomies\u003c/span\u003e()\n\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e\n\t})\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"三细枝末节\"\u003e三、细枝末节\u003c/h2\u003e\n\u003ch3 id=\"31-interface-实现约束\"\u003e3.1 interface 实现约束\u003c/h3\u003e\n\u003cp\u003e代码中有多处使用如下方式在编译时约束 interface 被实现。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"color:#66d9ef\"\u003evar\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003e_\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecmder\u003c/span\u003e = (\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003enewCmd\u003c/span\u003e)(\u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e其他开源项目中有也有这种写法的：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"color:#66d9ef\"\u003evar\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003e_\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecmder\u003c/span\u003e = \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003enewCmd\u003c/span\u003e{}\n\u003cspan style=\"color:#66d9ef\"\u003evar\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003e_\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecmder\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003enewCmd\u003c/span\u003e{}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"32-防抖\"\u003e3.2 防抖\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"color:#f92672\"\u003epackage\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edebounce\u003c/span\u003e\n\n\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e (\n\t\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sync\u0026#34;\u003c/span\u003e\n\t\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;time\u0026#34;\u003c/span\u003e\n)\n\n\u003cspan style=\"color:#75715e\"\u003e// New returns a debounced function that takes another functions as its argument.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e// This function will be called when the debounced function stops being called\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e// for the given duration.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e// The debounced function can be invoked with different functions, if needed,\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e// the last one will win.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eNew\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eafter\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eDuration\u003c/span\u003e) \u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ef\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e()) {\n\t\u003cspan style=\"color:#a6e22e\"\u003ed\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003edebouncer\u003c/span\u003e{\u003cspan style=\"color:#a6e22e\"\u003eafter\u003c/span\u003e: \u003cspan style=\"color:#a6e22e\"\u003eafter\u003c/span\u003e}\n\n\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ef\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e()) {\n\t\t\u003cspan style=\"color:#a6e22e\"\u003ed\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eadd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ef\u003c/span\u003e)\n\t}\n}\n\n\u003cspan style=\"color:#66d9ef\"\u003etype\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edebouncer\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003estruct\u003c/span\u003e {\n\t\u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e    \u003cspan style=\"color:#a6e22e\"\u003esync\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eMutex\u003c/span\u003e\n\t\u003cspan style=\"color:#a6e22e\"\u003eafter\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eDuration\u003c/span\u003e\n\t\u003cspan style=\"color:#a6e22e\"\u003etimer\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eTimer\u003c/span\u003e\n}\n\n\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003ed\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003edebouncer\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003eadd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ef\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e()) {\n\t\u003cspan style=\"color:#a6e22e\"\u003ed\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eLock\u003c/span\u003e()\n\t\u003cspan style=\"color:#66d9ef\"\u003edefer\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ed\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eUnlock\u003c/span\u003e()\n\n    \u003cspan style=\"color:#75715e\"\u003e// 如果正在延时中，取消当前延时，添加新的延时\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ed\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003etimer\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e {\n\t\t\u003cspan style=\"color:#a6e22e\"\u003ed\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003etimer\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eStop\u003c/span\u003e()\n\t}\n\t\u003cspan style=\"color:#a6e22e\"\u003ed\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003etimer\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eAfterFunc\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ed\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eafter\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ef\u003c/span\u003e)\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e防抖函数的使用类似 React Hooks。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"color:#a6e22e\"\u003ef\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e()\n\u003cspan style=\"color:#a6e22e\"\u003erun\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edebounce\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eNew\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ef\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003erun\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e在 Istio 源码中，处理 XDS 推流时也会进行防抖处理。\u003c/p\u003e\n\u003ch3 id=\"32-lifo-队列\"\u003e3.2 LIFO 队列\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"color:#75715e\"\u003e// LIFO 队列，溢出的元素会从顶部移除\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e// 没有主动删除元素的方法\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e// EvictingStringQueue is a queue which automatically evicts elements from the head of\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e// the queue when attempting to add new elements onto the queue and it is full.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e// This queue orders elements LIFO (last-in-first-out). It throws away duplicates.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e// Note: This queue currently does not contain any remove (poll etc.) methods.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003etype\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eEvictingStringQueue\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003estruct\u003c/span\u003e {\n\t\u003cspan style=\"color:#a6e22e\"\u003esize\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e\n\t\u003cspan style=\"color:#a6e22e\"\u003evals\u003c/span\u003e []\u003cspan style=\"color:#66d9ef\"\u003estring\u003c/span\u003e \u003cspan style=\"color:#75715e\"\u003e// 储存真实的数据\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#a6e22e\"\u003eset\u003c/span\u003e  \u003cspan style=\"color:#66d9ef\"\u003emap\u003c/span\u003e[\u003cspan style=\"color:#66d9ef\"\u003estring\u003c/span\u003e]\u003cspan style=\"color:#66d9ef\"\u003ebool\u003c/span\u003e \u003cspan style=\"color:#75715e\"\u003e// 表示是否已经存在\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e   \u003cspan style=\"color:#a6e22e\"\u003esync\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eMutex\u003c/span\u003e\n}\n\n\u003cspan style=\"color:#75715e\"\u003e// NewEvictingStringQueue creates a new queue with the given size.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eNewEvictingStringQueue\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003esize\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eEvictingStringQueue\u003c/span\u003e {\n\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eEvictingStringQueue\u003c/span\u003e{\u003cspan style=\"color:#a6e22e\"\u003esize\u003c/span\u003e: \u003cspan style=\"color:#a6e22e\"\u003esize\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eset\u003c/span\u003e: make(\u003cspan style=\"color:#66d9ef\"\u003emap\u003c/span\u003e[\u003cspan style=\"color:#66d9ef\"\u003estring\u003c/span\u003e]\u003cspan style=\"color:#66d9ef\"\u003ebool\u003c/span\u003e)}\n}\n\n\u003cspan style=\"color:#75715e\"\u003e// Add adds a new string to the tail of the queue if it\u0026#39;s not already there.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eEvictingStringQueue\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003eAdd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ev\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003estring\u003c/span\u003e) {\n\t\u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eLock\u003c/span\u003e()\n\t\u003cspan style=\"color:#75715e\"\u003e// 已经存在\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eset\u003c/span\u003e[\u003cspan style=\"color:#a6e22e\"\u003ev\u003c/span\u003e] {\n\t\t\u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eUnlock\u003c/span\u003e()\n\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e\n\t}\n\n\t\u003cspan style=\"color:#75715e\"\u003e// 数量达到最大限制\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e len(\u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eset\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003esize\u003c/span\u003e {\n\t\t\u003cspan style=\"color:#75715e\"\u003e// Full\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#75715e\"\u003e// 移除了 0 号元素的占位符\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\tdelete(\u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eset\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003evals\u003c/span\u003e[\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e])\n\t\t\u003cspan style=\"color:#75715e\"\u003e// :0 取空数组，1:取不包含第一个元素的其余元素\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#75715e\"\u003e// 移除了数组 0 号元素\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003evals\u003c/span\u003e = append(\u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003evals\u003c/span\u003e[:\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e], \u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003evals\u003c/span\u003e[\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e:]\u003cspan style=\"color:#f92672\"\u003e...\u003c/span\u003e)\n\t}\n\t\u003cspan style=\"color:#75715e\"\u003e// 表示存在\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eset\u003c/span\u003e[\u003cspan style=\"color:#a6e22e\"\u003ev\u003c/span\u003e] = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e\n\t\u003cspan style=\"color:#75715e\"\u003e// 最新插入的值在数组最后\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#75715e\"\u003e// 是队列结构\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003evals\u003c/span\u003e = append(\u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003evals\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ev\u003c/span\u003e)\n\t\u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eUnlock\u003c/span\u003e()\n}\n\n\u003cspan style=\"color:#75715e\"\u003e// Contains returns whether the queue contains v.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eEvictingStringQueue\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003eContains\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ev\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003estring\u003c/span\u003e) \u003cspan style=\"color:#66d9ef\"\u003ebool\u003c/span\u003e {\n\t\u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eLock\u003c/span\u003e()\n\t\u003cspan style=\"color:#66d9ef\"\u003edefer\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eUnlock\u003c/span\u003e()\n\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eset\u003c/span\u003e[\u003cspan style=\"color:#a6e22e\"\u003ev\u003c/span\u003e]\n}\n\n\u003cspan style=\"color:#75715e\"\u003e// Peek looks at the last element added to the queue.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eEvictingStringQueue\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003ePeek\u003c/span\u003e() \u003cspan style=\"color:#66d9ef\"\u003estring\u003c/span\u003e {\n\t\u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eLock\u003c/span\u003e()\n\t\u003cspan style=\"color:#a6e22e\"\u003el\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e len(\u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003evals\u003c/span\u003e)\n\t\u003cspan style=\"color:#75715e\"\u003e// 处理边界条件\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003el\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e {\n\t\t\u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eUnlock\u003c/span\u003e()\n\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\n\t}\n\t\u003cspan style=\"color:#75715e\"\u003e// 取最后一个元素\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#a6e22e\"\u003eelem\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003evals\u003c/span\u003e[\u003cspan style=\"color:#a6e22e\"\u003el\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e]\n\t\u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eUnlock\u003c/span\u003e()\n\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelem\u003c/span\u003e\n}\n\n\u003cspan style=\"color:#75715e\"\u003e// PeekAll looks at all the elements in the queue, with the newest first.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eEvictingStringQueue\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003ePeekAll\u003c/span\u003e() []\u003cspan style=\"color:#66d9ef\"\u003estring\u003c/span\u003e {\n\t\u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eLock\u003c/span\u003e()\n\t\u003cspan style=\"color:#a6e22e\"\u003evals\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e make([]\u003cspan style=\"color:#66d9ef\"\u003estring\u003c/span\u003e, len(\u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003evals\u003c/span\u003e))\n\tcopy(\u003cspan style=\"color:#a6e22e\"\u003evals\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003evals\u003c/span\u003e)\n\t\u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eUnlock\u003c/span\u003e()\n\t\u003cspan style=\"color:#75715e\"\u003e// i 从头开始循环 j 从尾循环\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#75715e\"\u003e// 交换 i j 元素位置\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#75715e\"\u003e// 数组 reverse\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#75715e\"\u003e// 最后插入的在最前面\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#66d9ef\"\u003efor\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ej\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, len(\u003cspan style=\"color:#a6e22e\"\u003evals\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e; \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#a6e22e\"\u003ej\u003c/span\u003e; \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ej\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ej\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e {\n\t\t\u003cspan style=\"color:#a6e22e\"\u003evals\u003c/span\u003e[\u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e], \u003cspan style=\"color:#a6e22e\"\u003evals\u003c/span\u003e[\u003cspan style=\"color:#a6e22e\"\u003ej\u003c/span\u003e] = \u003cspan style=\"color:#a6e22e\"\u003evals\u003c/span\u003e[\u003cspan style=\"color:#a6e22e\"\u003ej\u003c/span\u003e], \u003cspan style=\"color:#a6e22e\"\u003evals\u003c/span\u003e[\u003cspan style=\"color:#a6e22e\"\u003ei\u003c/span\u003e]\n\t}\n\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003evals\u003c/span\u003e\n}\n\n\u003cspan style=\"color:#75715e\"\u003e// PeekAllSet returns PeekAll as a set.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eEvictingStringQueue\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003ePeekAllSet\u003c/span\u003e() \u003cspan style=\"color:#66d9ef\"\u003emap\u003c/span\u003e[\u003cspan style=\"color:#66d9ef\"\u003estring\u003c/span\u003e]\u003cspan style=\"color:#66d9ef\"\u003ebool\u003c/span\u003e {\n\t\u003cspan style=\"color:#a6e22e\"\u003eall\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eq\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ePeekAll\u003c/span\u003e()\n\t\u003cspan style=\"color:#a6e22e\"\u003eset\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e make(\u003cspan style=\"color:#66d9ef\"\u003emap\u003c/span\u003e[\u003cspan style=\"color:#66d9ef\"\u003estring\u003c/span\u003e]\u003cspan style=\"color:#66d9ef\"\u003ebool\u003c/span\u003e)\n\t\u003cspan style=\"color:#66d9ef\"\u003efor\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003e_\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ev\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003erange\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eall\u003c/span\u003e {\n\t\t\u003cspan style=\"color:#a6e22e\"\u003eset\u003c/span\u003e[\u003cspan style=\"color:#a6e22e\"\u003ev\u003c/span\u003e] = \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e\n\t}\n\n\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eset\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"33-同步信号量\"\u003e3.3 同步信号量\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003egolang.org/x/sync/semaphore\u003c/code\u003e 扩展同步原语。\u003c/p\u003e\n\u003ch3 id=\"34-command\"\u003e3.4 Command\u003c/h3\u003e\n\u003ch4 id=\"341-cli-自动补全\"\u003e3.4.1 CLI 自动补全\u003c/h4\u003e\n\u003cp\u003e\n\u003cfigure class=\"image\"\u003e\n  \u003cimg src=\"/2020/12/hugo-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/images/hugo-cli.png\" alt=\"\" loading=\"lazy\" /\u003e\n  \n\u003c/figure\u003e\u003c/p\u003e\n\u003cp\u003eHugo 的使用方式有两种：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"color:#75715e\"\u003e// \u0026#34;-config\u0026#34; flag 自动补全指定后缀文件名\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003e_\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003ecc\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ecmd\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ePersistentFlags\u003c/span\u003e().\u003cspan style=\"color:#a6e22e\"\u003eSetAnnotation\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;config\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ecobra\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eBashCompFilenameExt\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003econfig\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eValidConfigFileExtensions\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e// \u0026#34;-source\u0026#34; flag 自动补全子文件夹名\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ecmd\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ePersistentFlags\u003c/span\u003e().\u003cspan style=\"color:#a6e22e\"\u003eSetAnnotation\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;source\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ecobra\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eBashCompSubdirsInDir\u003c/span\u003e, []\u003cspan style=\"color:#66d9ef\"\u003estring\u003c/span\u003e{})\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"35-并发控制\"\u003e3.5 并发控制\u003c/h3\u003e\n\u003ch4 id=\"351-缓冲通道控制并发\"\u003e3.5.1 缓冲通道控制并发\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"color:#75715e\"\u003e// common/para/para.go\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e// Package para implements parallel execution helpers.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003epackage\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epara\u003c/span\u003e\n\n\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e (\n\t\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;context\u0026#34;\u003c/span\u003e\n\n\t\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;golang.org/x/sync/errgroup\u0026#34;\u003c/span\u003e\n)\n\n\u003cspan style=\"color:#75715e\"\u003e// Workers configures a task executor with the most number of tasks to be executed in parallel.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003etype\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eWorkers\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003estruct\u003c/span\u003e {\n\t\u003cspan style=\"color:#a6e22e\"\u003esem\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003echan\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003estruct\u003c/span\u003e{}\n}\n\n\u003cspan style=\"color:#75715e\"\u003e// Runner wraps the lifecycle methods of a new task set.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e//\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e// Run wil block until a worker is available or the context is cancelled,\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e// and then run the given func in a new goroutine.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e// Wait will wait for all the running goroutines to finish.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003etype\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eRunner\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003einterface\u003c/span\u003e {\n\t\u003cspan style=\"color:#a6e22e\"\u003eRun\u003c/span\u003e(\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e() \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e)\n\t\u003cspan style=\"color:#a6e22e\"\u003eWait\u003c/span\u003e() \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e\n}\n\n\u003cspan style=\"color:#66d9ef\"\u003etype\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eerrGroupRunner\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003estruct\u003c/span\u003e {\n\t\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eerrgroup\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eGroup\u003c/span\u003e\n\t\u003cspan style=\"color:#a6e22e\"\u003ew\u003c/span\u003e   \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eWorkers\u003c/span\u003e\n\t\u003cspan style=\"color:#a6e22e\"\u003ectx\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003econtext\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eContext\u003c/span\u003e\n}\n\n\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eg\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eerrGroupRunner\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003eRun\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003efn\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e() \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e) {\n\t\u003cspan style=\"color:#66d9ef\"\u003eselect\u003c/span\u003e {\n\t\u003cspan style=\"color:#75715e\"\u003e// 分配一个信号, 如果 chan 被关闭则退出\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#66d9ef\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eg\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ew\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003esem\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003estruct\u003c/span\u003e{}{}:\n\t\u003cspan style=\"color:#66d9ef\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eg\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ectx\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eDone\u003c/span\u003e():\n\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e\n\t}\n\n\t\u003cspan style=\"color:#a6e22e\"\u003eg\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eGo\u003c/span\u003e(\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e() \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e {\n\t\t\u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efn\u003c/span\u003e()\n\t\t\u003cspan style=\"color:#75715e\"\u003e// 执行完后消费信号量, 通过缓存通道保证并发执行的协程数量\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eg\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ew\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003esem\u003c/span\u003e\n\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e\n\t})\n}\n\n\u003cspan style=\"color:#75715e\"\u003e// New creates a new Workers with the given number of workers.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eNew\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003enumWorkers\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eWorkers\u003c/span\u003e {\n\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eWorkers\u003c/span\u003e{\n\t\t\u003cspan style=\"color:#75715e\"\u003e// 缓冲通道, 并发写入\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#a6e22e\"\u003esem\u003c/span\u003e: make(\u003cspan style=\"color:#66d9ef\"\u003echan\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003estruct\u003c/span\u003e{}, \u003cspan style=\"color:#a6e22e\"\u003enumWorkers\u003c/span\u003e),\n\t}\n}\n\n\u003cspan style=\"color:#75715e\"\u003e// Start starts a new Runner.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003ew\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eWorkers\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003eStart\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ectx\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003econtext\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eContext\u003c/span\u003e) (\u003cspan style=\"color:#a6e22e\"\u003eRunner\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003econtext\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eContext\u003c/span\u003e) {\n\t\u003cspan style=\"color:#a6e22e\"\u003eg\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ectx\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eerrgroup\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eWithContext\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ectx\u003c/span\u003e)\n\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eerrGroupRunner\u003c/span\u003e{\n\t\t\u003cspan style=\"color:#a6e22e\"\u003eGroup\u003c/span\u003e: \u003cspan style=\"color:#a6e22e\"\u003eg\u003c/span\u003e,\n\t\t\u003cspan style=\"color:#a6e22e\"\u003ectx\u003c/span\u003e:   \u003cspan style=\"color:#a6e22e\"\u003ectx\u003c/span\u003e,\n\t\t\u003cspan style=\"color:#a6e22e\"\u003ew\u003c/span\u003e:     \u003cspan style=\"color:#a6e22e\"\u003ew\u003c/span\u003e,\n\t}, \u003cspan style=\"color:#a6e22e\"\u003ectx\u003c/span\u003e\n}\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003ePlayground 测试示例: \u003ca href=\"https://play.golang.org/p/4AJtyVnlSOd\"\u003ehttps://play.golang.org/p/4AJtyVnlSOd\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emain\u003c/span\u003e() {\n\t\u003cspan style=\"color:#a6e22e\"\u003ew\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epara\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eNew\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)\n\t\u003cspan style=\"color:#a6e22e\"\u003erunner\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003e_\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ew\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eStart\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003econtext\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eTODO\u003c/span\u003e())\n\t\u003cspan style=\"color:#a6e22e\"\u003erunner\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eRun\u003c/span\u003e(\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e() \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e {\n\t\t\u003cspan style=\"color:#a6e22e\"\u003efmt\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ePrintln\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;fucking\u0026#34;\u003c/span\u003e)\n\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e\n\t})\n\t\u003cspan style=\"color:#a6e22e\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eSleep\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eSecond\u003c/span\u003e)\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"36-懒加载\"\u003e3.6 懒加载\u003c/h3\u003e\n\u003cblockquote\u003e\n\u003cp\u003eLazy 包\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch4 id=\"361-oncemore\"\u003e3.6.1 onceMore\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"color:#f92672\"\u003epackage\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elazy\u003c/span\u003e\n\n\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e (\n\t\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sync\u0026#34;\u003c/span\u003e\n\t\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sync/atomic\u0026#34;\u003c/span\u003e\n)\n\n\u003cspan style=\"color:#75715e\"\u003e// onceMore is similar to sync.Once.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e//\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e// Additional features are:\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e// * it can be reset, so the action can be repeated if needed\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e// * it has methods to check if it\u0026#39;s done or in progress\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e//\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003etype\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eonceMore\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003estruct\u003c/span\u003e {\n\t\u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e   \u003cspan style=\"color:#a6e22e\"\u003esync\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eMutex\u003c/span\u003e\n\t\u003cspan style=\"color:#a6e22e\"\u003elock\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003euint32\u003c/span\u003e\n\t\u003cspan style=\"color:#a6e22e\"\u003edone\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003euint32\u003c/span\u003e\n}\n\n\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eonceMore\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003eDo\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ef\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e()) {\n\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eatomic\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eLoadUint32\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003edone\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e {\n\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e\n\t}\n\n\t\u003cspan style=\"color:#75715e\"\u003e// f may call this Do and we would get a deadlock.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#a6e22e\"\u003elocked\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eatomic\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eCompareAndSwapUint32\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003elock\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)\n\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e !\u003cspan style=\"color:#a6e22e\"\u003elocked\u003c/span\u003e {\n\t\t\u003cspan style=\"color:#75715e\"\u003e// 没有抢到原子操作\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e\n\t}\n\t\u003cspan style=\"color:#75715e\"\u003e// 释放原子锁\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#75715e\"\u003e// defer 是 FILO, 该原子锁会最后才释放\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#66d9ef\"\u003edefer\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eatomic\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eStoreUint32\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003elock\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)\n\n\t\u003cspan style=\"color:#75715e\"\u003e// 并发锁, 保证 t.done 值的读取不会产生竞争\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eLock\u003c/span\u003e()\n\t\u003cspan style=\"color:#66d9ef\"\u003edefer\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eUnlock\u003c/span\u003e()\n\n\t\u003cspan style=\"color:#75715e\"\u003e// Double check\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003edone\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e {\n\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e\n\t}\n\t\u003cspan style=\"color:#66d9ef\"\u003edefer\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eatomic\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eStoreUint32\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003edone\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)\n\t\u003cspan style=\"color:#a6e22e\"\u003ef\u003c/span\u003e()\n}\n\n\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eonceMore\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003eInProgress\u003c/span\u003e() \u003cspan style=\"color:#66d9ef\"\u003ebool\u003c/span\u003e {\n\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eatomic\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eLoadUint32\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003elock\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\n}\n\n\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eonceMore\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003eDone\u003c/span\u003e() \u003cspan style=\"color:#66d9ef\"\u003ebool\u003c/span\u003e {\n\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eatomic\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eLoadUint32\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003edone\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\n}\n\n\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eonceMore\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003eResetWithLock\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003esync\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eMutex\u003c/span\u003e {\n\t\u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eLock\u003c/span\u003e()\n\t\u003cspan style=\"color:#66d9ef\"\u003edefer\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eatomic\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eStoreUint32\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003edone\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)\n\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e\n}\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch4 id=\"362-init\"\u003e3.6.2 init\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"color:#f92672\"\u003epackage\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elazy\u003c/span\u003e\n\n\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e (\n\t\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;context\u0026#34;\u003c/span\u003e\n\t\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sync\u0026#34;\u003c/span\u003e\n\t\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;time\u0026#34;\u003c/span\u003e\n\n\t\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;github.com/pkg/errors\u0026#34;\u003c/span\u003e\n)\n\n\u003cspan style=\"color:#75715e\"\u003e// New creates a new empty Init.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eNew\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e {\n\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e{}\n}\n\n\u003cspan style=\"color:#75715e\"\u003e// Init holds a graph of lazily initialized dependencies.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003etype\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003estruct\u003c/span\u003e {\n\t\u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esync\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eMutex\u003c/span\u003e \u003cspan style=\"color:#75715e\"\u003e// 并发修改图的锁\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\n\t\u003cspan style=\"color:#a6e22e\"\u003eprev\u003c/span\u003e     \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e\n\t\u003cspan style=\"color:#a6e22e\"\u003echildren\u003c/span\u003e []\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e\n\n\t\u003cspan style=\"color:#a6e22e\"\u003einit\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eonceMore\u003c/span\u003e \u003cspan style=\"color:#75715e\"\u003e// 保证只执行一次的锁\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#a6e22e\"\u003eout\u003c/span\u003e  \u003cspan style=\"color:#66d9ef\"\u003einterface\u003c/span\u003e{} \u003cspan style=\"color:#75715e\"\u003e// 执行结果\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e  \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e \u003cspan style=\"color:#75715e\"\u003e// 执行错误\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#a6e22e\"\u003ef\u003c/span\u003e    \u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e() (\u003cspan style=\"color:#66d9ef\"\u003einterface\u003c/span\u003e{}, \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e) \u003cspan style=\"color:#75715e\"\u003e// 回调函数\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e}\n\n\u003cspan style=\"color:#75715e\"\u003e// Add adds a func as a new child dependency.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003eAdd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003einitFn\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e() (\u003cspan style=\"color:#66d9ef\"\u003einterface\u003c/span\u003e{}, \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e {\n\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e {\n\t\t\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eNew\u003c/span\u003e()\n\t}\n\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eadd\u003c/span\u003e(\u003cspan style=\"color:#66d9ef\"\u003efalse\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003einitFn\u003c/span\u003e)\n}\n\n\u003cspan style=\"color:#75715e\"\u003e// AddWithTimeout is same as Add, but with a timeout that aborts initialization.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003eAddWithTimeout\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etimeout\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eDuration\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ef\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ectx\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003econtext\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eContext\u003c/span\u003e) (\u003cspan style=\"color:#66d9ef\"\u003einterface\u003c/span\u003e{}, \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e {\n\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eAdd\u003c/span\u003e(\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e() (\u003cspan style=\"color:#66d9ef\"\u003einterface\u003c/span\u003e{}, \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e) {\n\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ewithTimeout\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etimeout\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ef\u003c/span\u003e)\n\t})\n}\n\n\u003cspan style=\"color:#75715e\"\u003e// Branch creates a new dependency branch based on an existing and adds\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e// the given dependency as a child.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003eBranch\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003einitFn\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e() (\u003cspan style=\"color:#66d9ef\"\u003einterface\u003c/span\u003e{}, \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e {\n\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e {\n\t\t\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eNew\u003c/span\u003e()\n\t}\n\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eadd\u003c/span\u003e(\u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003einitFn\u003c/span\u003e)\n}\n\n\u003cspan style=\"color:#75715e\"\u003e// BranchdWithTimeout is same as Branch, but with a timeout.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003eBranchWithTimeout\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etimeout\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eDuration\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ef\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ectx\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003econtext\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eContext\u003c/span\u003e) (\u003cspan style=\"color:#66d9ef\"\u003einterface\u003c/span\u003e{}, \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e {\n\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eBranch\u003c/span\u003e(\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e() (\u003cspan style=\"color:#66d9ef\"\u003einterface\u003c/span\u003e{}, \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e) {\n\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ewithTimeout\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etimeout\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ef\u003c/span\u003e)\n\t})\n}\n\n\u003cspan style=\"color:#75715e\"\u003e// Do initializes the entire dependency graph.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003eDo\u003c/span\u003e() (\u003cspan style=\"color:#66d9ef\"\u003einterface\u003c/span\u003e{}, \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e) {\n\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e {\n\t\tpanic(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;init is nil\u0026#34;\u003c/span\u003e)\n\t}\n\n\t\u003cspan style=\"color:#75715e\"\u003e// 调用 onceMore 库保证只执行一次\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003einit\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eDo\u003c/span\u003e(\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e() {\n\t\t\u003cspan style=\"color:#75715e\"\u003e// 获取父节点\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#a6e22e\"\u003eprev\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eprev\u003c/span\u003e\n\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eprev\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e {\n\t\t\t\u003cspan style=\"color:#75715e\"\u003e// A branch. Initialize the ancestors.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\t\u003cspan style=\"color:#75715e\"\u003e// 若父节点还没有完成初始化, 并且没有正在执行的回调函数, 执行\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eprev\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eshouldInitialize\u003c/span\u003e() {\n\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003e_\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eprev\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eDo\u003c/span\u003e()\n\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e {\n\t\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e\n\t\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e\n\t\t\t\t}\n\t\t\t} \u003cspan style=\"color:#66d9ef\"\u003eelse\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eprev\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003einProgress\u003c/span\u003e() {\n\t\t\t\t\u003cspan style=\"color:#75715e\"\u003e// Concurrent initialization. The following init func\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\t\t\u003cspan style=\"color:#75715e\"\u003e// may depend on earlier state, so wait.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\t\t\u003cspan style=\"color:#75715e\"\u003e// 等待一定时间, 若没有执行完, panic\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003eprev\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ewait\u003c/span\u003e()\n\t\t\t}\n\t\t}\n\n\t\t\u003cspan style=\"color:#75715e\"\u003e// 执行回调函数\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ef\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e {\n\t\t\t\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eout\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ef\u003c/span\u003e()\n\t\t}\n\n\t\t\u003cspan style=\"color:#75715e\"\u003e// 循环执行子节点的回调函数\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#75715e\"\u003e// 为什么不并发执行 ?\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#66d9ef\"\u003efor\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003e_\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003echild\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003erange\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003echildren\u003c/span\u003e {\n\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003echild\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eshouldInitialize\u003c/span\u003e() {\n\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003e_\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003echild\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eDo\u003c/span\u003e()\n\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e {\n\t\t\t\t\t\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e = \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e\n\t\t\t\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t})\n\n\t\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ewait\u003c/span\u003e()\n\n\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eout\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e\n}\n\n\u003cspan style=\"color:#75715e\"\u003e// TODO(bep) investigate if we can use sync.Cond for this.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003ewait\u003c/span\u003e() {\n\t\u003cspan style=\"color:#66d9ef\"\u003evar\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecounter\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eDuration\u003c/span\u003e\n\t\u003cspan style=\"color:#66d9ef\"\u003efor\u003c/span\u003e !\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003einit\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eDone\u003c/span\u003e() {\n\t\t\u003cspan style=\"color:#a6e22e\"\u003ecounter\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e\n\t\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecounter\u003c/span\u003e \u0026gt; \u003cspan style=\"color:#ae81ff\"\u003e600000000\u003c/span\u003e {\n\t\t\tpanic(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;BUG: timed out in lazy init\u0026#34;\u003c/span\u003e)\n\t\t}\n\t\t\u003cspan style=\"color:#a6e22e\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eSleep\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ecounter\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eMicrosecond\u003c/span\u003e)\n\t}\n}\n\n\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003einProgress\u003c/span\u003e() \u003cspan style=\"color:#66d9ef\"\u003ebool\u003c/span\u003e {\n\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003einit\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eInProgress\u003c/span\u003e()\n}\n\n\u003cspan style=\"color:#75715e\"\u003e// 若 没有注册了回调函数 | 已经完成 | 正在执行, 不进行初始化\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003eshouldInitialize\u003c/span\u003e() \u003cspan style=\"color:#66d9ef\"\u003ebool\u003c/span\u003e {\n\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e !(\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e||\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003einit\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eDone\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e||\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003einit\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eInProgress\u003c/span\u003e())\n}\n\n\u003cspan style=\"color:#75715e\"\u003e// Reset resets the current and all its dependencies.\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003eReset\u003c/span\u003e() {\n\t\u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003einit\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eResetWithLock\u003c/span\u003e()\n\t\u003cspan style=\"color:#66d9ef\"\u003edefer\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eUnlock\u003c/span\u003e()\n\t\u003cspan style=\"color:#66d9ef\"\u003efor\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003e_\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ed\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003erange\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003echildren\u003c/span\u003e {\n\t\t\u003cspan style=\"color:#a6e22e\"\u003ed\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eReset\u003c/span\u003e()\n\t}\n}\n\n\u003cspan style=\"color:#75715e\"\u003e// 添加图的节点\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003eadd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ebranch\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003ebool\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003einitFn\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e() (\u003cspan style=\"color:#66d9ef\"\u003einterface\u003c/span\u003e{}, \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e {\n\t\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eLock\u003c/span\u003e()\n\t\u003cspan style=\"color:#66d9ef\"\u003edefer\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003emu\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eUnlock\u003c/span\u003e()\n\n\t\u003cspan style=\"color:#75715e\"\u003e// 如果是新建分支\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ebranch\u003c/span\u003e {\n\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e{\n\t\t\t\u003cspan style=\"color:#a6e22e\"\u003ef\u003c/span\u003e:    \u003cspan style=\"color:#a6e22e\"\u003einitFn\u003c/span\u003e,\n\t\t\t\u003cspan style=\"color:#a6e22e\"\u003eprev\u003c/span\u003e: \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e, \u003cspan style=\"color:#75715e\"\u003e// 父节点\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t}\n\t}\n\n\t\u003cspan style=\"color:#75715e\"\u003e// 如果是添加子节点\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#75715e\"\u003e// 如果已经被执行, panic\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003echeckDone\u003c/span\u003e()\n\t\u003cspan style=\"color:#75715e\"\u003e// 添加子节点\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003echildren\u003c/span\u003e = append(\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003echildren\u003c/span\u003e, \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e{\n\t\t\u003cspan style=\"color:#a6e22e\"\u003ef\u003c/span\u003e: \u003cspan style=\"color:#a6e22e\"\u003einitFn\u003c/span\u003e,\n\t})\n\n\t\u003cspan style=\"color:#75715e\"\u003e// 释放锁\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e\n}\n\n\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003echeckDone\u003c/span\u003e() {\n\t\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003einit\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eDone\u003c/span\u003e() {\n\t\tpanic(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;init cannot be added to after it has run\u0026#34;\u003c/span\u003e)\n\t}\n}\n\n\u003cspan style=\"color:#75715e\"\u003e// callback 函数, 有超时时间\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#a6e22e\"\u003eini\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eInit\u003c/span\u003e) \u003cspan style=\"color:#a6e22e\"\u003ewithTimeout\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etimeout\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eDuration\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ef\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ectx\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003econtext\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eContext\u003c/span\u003e) (\u003cspan style=\"color:#66d9ef\"\u003einterface\u003c/span\u003e{}, \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e)) (\u003cspan style=\"color:#66d9ef\"\u003einterface\u003c/span\u003e{}, \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e) {\n\t\u003cspan style=\"color:#a6e22e\"\u003ectx\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ecancel\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003econtext\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eWithTimeout\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003econtext\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eBackground\u003c/span\u003e(), \u003cspan style=\"color:#a6e22e\"\u003etimeout\u003c/span\u003e)\n\t\u003cspan style=\"color:#66d9ef\"\u003edefer\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecancel\u003c/span\u003e()\n\t\u003cspan style=\"color:#75715e\"\u003e// 缓存通道, 防止阻塞\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e make(\u003cspan style=\"color:#66d9ef\"\u003echan\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003everr\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)\n\n\t\u003cspan style=\"color:#66d9ef\"\u003ego\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efunc\u003c/span\u003e() {\n\t\t\u003cspan style=\"color:#a6e22e\"\u003ev\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ef\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ectx\u003c/span\u003e)\n\t\t\u003cspan style=\"color:#66d9ef\"\u003eselect\u003c/span\u003e {\n\t\t\u003cspan style=\"color:#66d9ef\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ectx\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eDone\u003c/span\u003e():\n\t\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e\n\t\t\u003cspan style=\"color:#66d9ef\"\u003edefault\u003c/span\u003e:\n\t\t\t\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003everr\u003c/span\u003e{\u003cspan style=\"color:#a6e22e\"\u003ev\u003c/span\u003e: \u003cspan style=\"color:#a6e22e\"\u003ev\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e: \u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e}\n\t\t}\n\t}()\n\n\t\u003cspan style=\"color:#66d9ef\"\u003eselect\u003c/span\u003e {\n\t\u003cspan style=\"color:#66d9ef\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ectx\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eDone\u003c/span\u003e():\n\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003enil\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eerrors\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eNew\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;timed out initializing value. You may have a circular loop in a shortcode, or your site may have resources that take longer to build than the `timeout` limit in your Hugo config file.\u0026#34;\u003c/span\u003e)\n\t\u003cspan style=\"color:#66d9ef\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eve\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e:\n\t\t\u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eve\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003ev\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eve\u003c/span\u003e.\u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e\n\t}\n}\n\n\u003cspan style=\"color:#66d9ef\"\u003etype\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003everr\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003estruct\u003c/span\u003e {\n\t\u003cspan style=\"color:#a6e22e\"\u003ev\u003c/span\u003e   \u003cspan style=\"color:#66d9ef\"\u003einterface\u003c/span\u003e{}\n\t\u003cspan style=\"color:#a6e22e\"\u003eerr\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eerror\u003c/span\u003e\n}\n\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e参考文章：\u003c/p\u003e\n\u003cp\u003e[1] \u003ca href=\"https://imroc.io/posts/kubernetes/analysis-exitcode/\"\u003eKubernetes 问题定位技巧：分析 ExitCode - imroc.io|roc的博客|Cloud Native|Kubernetes|Go|Golang\u003c/a\u003e\u003c/p\u003e"}</script>
<link rel=preload as=script href="/bundle.js?v=1631904279">
</head>
<body>
<header id=nav class=header>
<div class="ax-l-i max-w-6xl">
<div class=ax-logo>
<a class=block href=/ title="Mayo's Blog"><span class="font-semibold text-raven-900">Mayo's Blog</span></a>
</div>
<div class=ax-user>
<a class="p-2 w-8 h-8 block text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" target=_blank rel="noopener nofollow" href="https://www.google.com/search?q=site:/" title><svg class="fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.67 12.804c0-5.6 4.544-10.134 10.133-10.134s10.134 4.544 10.134 10.134-4.544 10.133-10.134 10.133S2.67 18.393 2.67 12.804zm28.943 16.923-8.868-8.868c4.287-5.3 3.68-13.012-1.378-17.57S8.564-1.066 3.75 3.75s-5.017 12.558-.46 17.618 12.28 5.665 17.57 1.378l8.868 8.868a1.33 1.33.0 002.231-.597c.123-.46-.008-.952-.345-1.29h0z"/></svg>
</a>
</div>
</div>
</header>
<main>
<div class=default-single>
<div class="ax-title ax-l-o">
<div class="ax-l-i max-w-5xl">
<h1 class="post-title font-content-title font-normal leading-tight tracking-default text-34 sm:text-40">Hugo 源码阅读</h1>
<div class="ax-meta flex items-center mt-5 max-w-3xl">
<div class="flex-grow min-w-0">
<div class="flex items-center space-x-5">
<div class="flex items-center">
<div class=flex-shrink-0>
<a href=/>
<img class="w-12 h-12 sm:w-14 sm:h-14 object-cover p-3px rounded-full border border-blue-300" src="data:image/svg+xml,%3Csvg viewBox=%220 0 32 32%22 xmlns=%22http://www.w3.org/2000/svg%22 xmlns:xlink=%22http://www.w3.org/1999/xlink%22%3E%3Cpath fill=%22%23eceff1%22 d=%22M0 0h32v32H0z%22/%3E%3Cpath fill=%22%23455a64%22 d=%22M29.305 24.407c-.795-.63-1.765-1.08-2.816-1.3L21.476 22.1a1.13 1.13.0 01-.905-1.12v-1.15c.322-.453.626-1.054.944-1.682.247-.487.62-1.22.805-1.4 1.015-1.02 1.995-2.165 2.3-3.64.283-1.385.005-2.112-.322-2.697.0-1.46-.046-3.29-.39-4.62-.04-1.8-.368-2.814-1.19-3.7-.58-.63-1.435-.775-2.123-.89-.27-.046-.642-.1-.78-.183C18.594.347 17.4.025 15.952.0c-3 .123-6.71 2.04-7.95 5.454-.384 1.04-.345 2.747-.313 4.12l-.03.825c-.295.576-.585 1.307-.3 2.697.302 1.48 1.282 2.626 2.315 3.66.17.174.55.914.802 1.403l.95 1.675v1.15c0 .546-.382 1.017-.9 1.12L5.5 23.11c-1.045.222-2.014.67-2.807 1.298a1.15 1.15.0 00-.427.805 1.14 1.14.0 00.293.859C5.975 29.838 10.873 32 16 32s10.027-2.16 13.44-5.93a1.14 1.14.0 00-.135-1.664z%22/%3E%3C/svg%3E" alt=Unknown>
</a>
</div>
<div class="flex-shrink-0 ml-2 leading-tight font-content-sans">
<a class="block text-base text-raven-800 hover:text-raven-900" target=_blank rel="noopener nofollow" title=Unknown href=/>Unknown</a>
<time class="text-sm text-raven-500" datetime=2020-12-10T00:00:00Z>12月 10, 2020 12:00AM</time>
</div>
</div>
<div class="flex items-center space-x-3 text-sm text-raven-500">
<div class=inline-block>
<a class="hover:text-raven-900 space-x-0.5" href=https://twitter.com/# target=_blank rel="noopener nofollow"><svg class="w-6 h-6 fill-current inline-block" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11.0 01-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56.0 00-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57.0 002.914 5.452 6.48 6.48.0 01-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42.0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57A13.18 13.18.0 011.57 26.146c-.538.0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072.0 18.672-10 18.672-18.668.0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg>
<span class="hidden sm:inline">@#</span>
</a>
</div>
<div class=inline-block>
<a class="hover:text-raven-900 space-x-0.5" href=https://github.com/# target=_blank rel="noopener nofollow"><svg class="w-6 h-6 fill-current inline-block" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M15.998.0C7.164.0.0 7.35.0 16.417.0 23.67 4.584 29.82 10.944 31.994c.8.15 1.092-.356 1.092-.79l-.022-2.792c-4.45.99-5.4-2.202-5.4-2.202-.726-1.896-1.776-2.4-1.776-2.4-1.454-1.018.108-.998.108-.998 1.606.117 2.45 1.693 2.45 1.693 1.428 2.507 3.746 1.784 4.658 1.363.144-1.06.558-1.784 1.016-2.195-3.552-.415-7.288-1.823-7.288-8.113.0-1.792.624-3.258 1.648-4.406-.166-.415-.714-2.085.156-4.344.0.0 1.344-.44 4.4 1.683 1.276-.364 2.644-.546 4.006-.552a14.98 14.98.0 014.006.554C23.062 6.37 24.404 6.8 24.404 6.8c.872 2.26.324 3.93.16 4.344 1.026 1.148 1.644 2.614 1.644 4.406.0 6.306-3.74 7.694-7.304 8.1.574.507 1.086 1.51 1.086 3.04l-.02 4.503c0 .44.288.95 1.1.788C27.42 29.817 32 23.667 32 16.417 32 7.35 24.836.0 15.998.0z"/></svg>
<span class="hidden sm:inline">@#</span>
</a>
</div>
</div>
</div>
</div>
</div>
</div>
</div><div class="ax-content ax-l-o">
<div class="ax-l-i max-w-5xl">
<div class=lg:flex>
<article class="cdata flex-grow max-w-3xl"><h1 id=hugo-源码阅读>Hugo 源码阅读</h1>
<blockquote>
<p>WIP</p>
</blockquote>
<h2 id=一概述>一、概述</h2>
<h3 id=11-目录结构>1.1 目录结构</h3>
<p>&mldr;</p>
<h2 id=二程序流程>二、程序流程</h2>
<h3 id=21-流程定义>2.1 流程定义</h3>
<h4 id=211-错误状态码>2.1.1 错误状态码</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#a6e22e>resp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>commands</span>.<span style=color:#a6e22e>Execute</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>:])

	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>IsUserError</span>() {
			<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Cmd</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;&#34;</span>)
			<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Cmd</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Cmd</span>.<span style=color:#a6e22e>UsageString</span>())
		}
		<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
	}
}
</code></pre></div><p><code>os.Exit(-1)</code> 程序的退出状态码不在 0~255 之间，会自动做转换，转换的规则如下[1]：</p>
<ul>
<li>当指定的退出时状态码为负数:</li>
</ul>
<pre tabindex=0><code class=language-fallback data-lang=fallback>256 - (|code| % 256)
</code></pre><ul>
<li>当指定的退出时状态码为正数:</li>
</ul>
<pre tabindex=0><code class=language-fallback data-lang=fallback>code % 256
</code></pre><p>由此程序退出的状态码为 255。</p>
<h4 id=212-cli-命令>2.1.2 CLI 命令</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// commands/commands.go
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>commandsBuilder</span>) <span style=color:#a6e22e>addAll</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>commandsBuilder</span> {
   <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>addCommands</span>(
      <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>newServerCmd</span>(),
      <span style=color:#a6e22e>newVersionCmd</span>(),
      <span style=color:#a6e22e>newEnvCmd</span>(),
      <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>newConfigCmd</span>(),
      <span style=color:#a6e22e>newCheckCmd</span>(),
      <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>newDeployCmd</span>(),
      <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>newConvertCmd</span>(),
      <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>newNewCmd</span>(),
      <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>newListCmd</span>(),
      <span style=color:#a6e22e>newImportCmd</span>(),
      <span style=color:#a6e22e>newGenCmd</span>(),
      <span style=color:#a6e22e>createReleaser</span>(),
      <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>newModCmd</span>(),
   )

   <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>b</span>
}
</code></pre></div><p>所有的 cmd handler 继承自 basecmd，实现了 cmder 接口：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// commands/helpers.go
</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>cmder</span> <span style=color:#66d9ef>interface</span> {
	<span style=color:#a6e22e>flagsToConfig</span>(<span style=color:#a6e22e>cfg</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Provider</span>)
	<span style=color:#a6e22e>getCommand</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>cobra</span>.<span style=color:#a6e22e>Command</span>
}
</code></pre></div><p>
<figure class=image>
<img src=/2020/12/hugo-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/images/hugo-impl.png alt loading=lazy>
</figure></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// commands/commands.go
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>commandsBuilder</span>) <span style=color:#a6e22e>addAll</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>commandsBuilder</span> {
	<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>addCommands</span>(
		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>newServerCmd</span>(),
		<span style=color:#a6e22e>newVersionCmd</span>(),
		<span style=color:#a6e22e>newEnvCmd</span>(),
		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>newConfigCmd</span>(),
		<span style=color:#a6e22e>newCheckCmd</span>(),
		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>newDeployCmd</span>(),
		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>newConvertCmd</span>(),
		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>newNewCmd</span>(),
		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>newListCmd</span>(),
		<span style=color:#a6e22e>newImportCmd</span>(),
		<span style=color:#a6e22e>newGenCmd</span>(),
		<span style=color:#a6e22e>createReleaser</span>(),
		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>newModCmd</span>(),
	)

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>b</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>commandsBuilder</span>) <span style=color:#a6e22e>build</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>hugoCmd</span> {
	<span style=color:#75715e>// 添加主 hugo 命令
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>h</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>newHugoCmd</span>()
	<span style=color:#75715e>// 将命令数组添加进 cobra 的 Root Command 中, 作为子命令
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>addCommands</span>(<span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>getCommand</span>(), <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>commands</span><span style=color:#f92672>...</span>)
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>h</span>
}
</code></pre></div><h3 id=22-渲染初始化>2.2 渲染初始化</h3>
<blockquote>
<p>执行 Hugo 命令时进行的初始化加载</p>
</blockquote>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// 创建 hugoCmd 封装块
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>commandsBuilder</span>) <span style=color:#a6e22e>newHugoCmd</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>hugoCmd</span> {
	<span style=color:#a6e22e>cc</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>hugoCmd</span>{}

	<span style=color:#a6e22e>cc</span>.<span style=color:#a6e22e>baseBuilderCmd</span> = <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>newBuilderCmd</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cobra</span>.<span style=color:#a6e22e>Command</span>{
		<span style=color:#a6e22e>Use</span>:   <span style=color:#e6db74>&#34;hugo&#34;</span>,
		<span style=color:#a6e22e>Short</span>: <span style=color:#e6db74>&#34;hugo builds your site&#34;</span>,
		<span style=color:#a6e22e>Long</span>: <span style=color:#e6db74>`hugo is the main command, used to build your Hugo site.
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>Hugo is a Fast and Flexible Static Site Generator
</span><span style=color:#e6db74>built with love by spf13 and friends in Go.
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>Complete documentation is available at http://gohugo.io/.`</span>,

		<span style=color:#75715e>// 执行渲染操作
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>RunE</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>cmd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>cobra</span>.<span style=color:#a6e22e>Command</span>, <span style=color:#a6e22e>args</span> []<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
			<span style=color:#75715e>// 记录全局操作耗时
</span><span style=color:#75715e></span>			<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cc</span>.<span style=color:#a6e22e>timeTrack</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>(), <span style=color:#e6db74>&#34;Total&#34;</span>)
			<span style=color:#a6e22e>cfgInit</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>commandeer</span>) <span style=color:#66d9ef>error</span> {
				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cc</span>.<span style=color:#a6e22e>buildWatch</span> {
					<span style=color:#75715e>// 如果开启了 watch 模式则关闭动态重载
</span><span style=color:#75715e></span>					<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;disableLiveReload&#34;</span>, <span style=color:#66d9ef>true</span>)
				}
				<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
			}

			<span style=color:#75715e>// 初始化配置
</span><span style=color:#75715e></span>			<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>initializeConfig</span>(<span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>cc</span>.<span style=color:#a6e22e>buildWatch</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cc</span>.<span style=color:#a6e22e>hugoBuilderCommon</span>, <span style=color:#a6e22e>cc</span>, <span style=color:#a6e22e>cfgInit</span>)
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
			}
			<span style=color:#a6e22e>cc</span>.<span style=color:#a6e22e>c</span> = <span style=color:#a6e22e>c</span>

			<span style=color:#75715e>// 编译操作
</span><span style=color:#75715e></span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>build</span>()
		},
	})
   
    <span style=color:#f92672>...</span>
</code></pre></div><h4 id=221-配置文件加载>2.2.1 配置文件加载</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// hugolib/config.go
</span><span style=color:#75715e></span>
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>configDir</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>configDirs</span> {
		<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>afero</span>.<span style=color:#a6e22e>Walk</span>(<span style=color:#a6e22e>sourceFs</span>, <span style=color:#a6e22e>configDir</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>path</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>fi</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>FileInfo</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>error</span> {
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>fi</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
				<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
			}

			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>fi</span>.<span style=color:#a6e22e>IsDir</span>() {
				<span style=color:#a6e22e>dirnames</span> = append(<span style=color:#a6e22e>dirnames</span>, <span style=color:#a6e22e>path</span>)
				<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
			}

			<span style=color:#75715e>// 检查文件后缀是否是支持的格式
</span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>IsValidConfigFilename</span>(<span style=color:#a6e22e>path</span>) {
				<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
			}

			<span style=color:#75715e>// 文件名, 移除文件后缀
</span><span style=color:#75715e></span>			<span style=color:#a6e22e>name</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>helpers</span>.<span style=color:#a6e22e>Filename</span>(<span style=color:#a6e22e>filepath</span>.<span style=color:#a6e22e>Base</span>(<span style=color:#a6e22e>path</span>))

			<span style=color:#75715e>// 加载文件内容到 map
</span><span style=color:#75715e></span>			<span style=color:#a6e22e>item</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>metadecoders</span>.<span style=color:#a6e22e>Default</span>.<span style=color:#a6e22e>UnmarshalFileToMap</span>(<span style=color:#a6e22e>sourceFs</span>, <span style=color:#a6e22e>path</span>)
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>wrapFileError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>path</span>)
			}

			<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>keyPath</span> []<span style=color:#66d9ef>string</span>

			<span style=color:#75715e>// 如果不是 hugo 的 config 文件
</span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>name</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;config&#34;</span> {
				<span style=color:#75715e>// Can be params.jp, menus.en etc.
</span><span style=color:#75715e></span>				<span style=color:#75715e>// 如果文件还有后缀, 可能是语言后缀
</span><span style=color:#75715e></span>				<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>lang</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>helpers</span>.<span style=color:#a6e22e>FileAndExtNoDelimiter</span>(<span style=color:#a6e22e>name</span>)

				<span style=color:#a6e22e>keyPath</span> = []<span style=color:#66d9ef>string</span>{<span style=color:#a6e22e>name</span>}

				<span style=color:#75715e>// 如果语言后缀存在
</span><span style=color:#75715e></span>				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>lang</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
					<span style=color:#75715e>// 填充语言文件夹路径
</span><span style=color:#75715e></span>					<span style=color:#a6e22e>keyPath</span> = []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;languages&#34;</span>, <span style=color:#a6e22e>lang</span>}
					<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>name</span> {
					<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;menu&#34;</span>, <span style=color:#e6db74>&#34;menus&#34;</span>:
						<span style=color:#a6e22e>keyPath</span> = append(<span style=color:#a6e22e>keyPath</span>, <span style=color:#e6db74>&#34;menus&#34;</span>)
					<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;params&#34;</span>:
						<span style=color:#a6e22e>keyPath</span> = append(<span style=color:#a6e22e>keyPath</span>, <span style=color:#e6db74>&#34;params&#34;</span>)
					}
				}
			}

			<span style=color:#a6e22e>root</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>item</span>
			<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>keyPath</span>) &gt; <span style=color:#ae81ff>0</span> {
				<span style=color:#a6e22e>root</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{})
				<span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>root</span>

				<span style=color:#75715e>// 遍历形成层级关系
</span><span style=color:#75715e></span>
				<span style=color:#75715e>// 遍历语言文件夹的路径
</span><span style=color:#75715e></span>				<span style=color:#75715e>// i 从 0 开始
</span><span style=color:#75715e></span>				<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>key</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>keyPath</span> {
					<span style=color:#75715e>// 如果 i &gt;= 最后一个元素的 index
</span><span style=color:#75715e></span>					<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>&gt;=</span> len(<span style=color:#a6e22e>keyPath</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
						<span style=color:#75715e>// 将文件内容填充到 key 下面
</span><span style=color:#75715e></span>						<span style=color:#a6e22e>m</span>[<span style=color:#a6e22e>key</span>] = <span style=color:#a6e22e>item</span>
					} <span style=color:#66d9ef>else</span> {
						<span style=color:#a6e22e>nm</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{})
						<span style=color:#a6e22e>m</span>[<span style=color:#a6e22e>key</span>] = <span style=color:#a6e22e>nm</span>
						<span style=color:#a6e22e>m</span> = <span style=color:#a6e22e>nm</span>
					}
				}
			}

			<span style=color:#75715e>// Migrate menu =&gt; menus etc.
</span><span style=color:#75715e></span>			<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>RenameKeys</span>(<span style=color:#a6e22e>root</span>)

			<span style=color:#75715e>// 合并配置文件
</span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>MergeConfigMap</span>(<span style=color:#a6e22e>root</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>wrapFileError</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>path</span>)
			}

			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
		})
</code></pre></div><p>遍历配置文件夹、以及加载配置文件（yaml/toml/json 后缀）到 Map 中，使用 Viper 的 <code>MergeConfigMap</code> 载入配置，包含语言、菜单配置。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// hugolib/hugo_sites.go
</span><span style=color:#75715e>// 创建 sites 的配置
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>createSitesFromConfig</span>(<span style=color:#a6e22e>cfg</span> <span style=color:#a6e22e>deps</span>.<span style=color:#a6e22e>DepsCfg</span>) ([]<span style=color:#f92672>*</span><span style=color:#a6e22e>Site</span>, <span style=color:#66d9ef>error</span>) {
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>sites</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>Site</span>

	<span style=color:#75715e>// 获取多语言配置
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>languages</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getLanguages</span>(<span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Cfg</span>)

	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>lang</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>languages</span> {
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>lang</span>.<span style=color:#a6e22e>Disabled</span> {
			<span style=color:#66d9ef>continue</span>
		}
		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Site</span>
		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
		<span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Language</span> = <span style=color:#a6e22e>lang</span>
		<span style=color:#75715e>// 为每个语言创建一个 site
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>newSite</span>(<span style=color:#a6e22e>cfg</span>)

		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
		}

		<span style=color:#a6e22e>sites</span> = append(<span style=color:#a6e22e>sites</span>, <span style=color:#a6e22e>s</span>)
	}

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sites</span>, <span style=color:#66d9ef>nil</span>
}
</code></pre></div><p>为每个语言生成一个 Site。</p>
<h4 id=222-内容加载>2.2.2 内容加载</h4>
<p>注册回调函数:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// hugolib/site.go
</span><span style=color:#75715e>// 初始化
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Site</span>) <span style=color:#a6e22e>prepareInits</span>() {
	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>init</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>siteInit</span>{}

	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>init</span> <span style=color:#a6e22e>lazy</span>.<span style=color:#a6e22e>Init</span>

	<span style=color:#75715e>// 回调函数
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>init</span>.<span style=color:#a6e22e>prevNext</span> = <span style=color:#a6e22e>init</span>.<span style=color:#a6e22e>Branch</span>(<span style=color:#66d9ef>func</span>() (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>) {
		<span style=color:#75715e>// 获取 pages
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>regularPages</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>RegularPages</span>()
		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>regularPages</span> {
			<span style=color:#a6e22e>np</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.(<span style=color:#a6e22e>nextPrevProvider</span>)
			<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
				<span style=color:#66d9ef>continue</span>
			}

			<span style=color:#a6e22e>pos</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>np</span>.<span style=color:#a6e22e>getNextPrev</span>()
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pos</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
				<span style=color:#66d9ef>continue</span>
			}

			<span style=color:#a6e22e>pos</span>.<span style=color:#a6e22e>nextPage</span> = <span style=color:#66d9ef>nil</span>
			<span style=color:#a6e22e>pos</span>.<span style=color:#a6e22e>prevPage</span> = <span style=color:#66d9ef>nil</span>

			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> &gt; <span style=color:#ae81ff>0</span> {
				<span style=color:#a6e22e>pos</span>.<span style=color:#a6e22e>nextPage</span> = <span style=color:#a6e22e>regularPages</span>[<span style=color:#a6e22e>i</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
			}

			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> &lt; len(<span style=color:#a6e22e>regularPages</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
				<span style=color:#a6e22e>pos</span>.<span style=color:#a6e22e>prevPage</span> = <span style=color:#a6e22e>regularPages</span>[<span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>]
			}
		}
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>
	})

	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>init</span>.<span style=color:#a6e22e>prevNextInSection</span> = <span style=color:#a6e22e>init</span>.<span style=color:#a6e22e>Branch</span>(<span style=color:#66d9ef>func</span>() (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>) {
		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>sections</span> <span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>Pages</span>
		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>home</span>.<span style=color:#a6e22e>treeRef</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>collectSectionsRecursiveIncludingSelf</span>(<span style=color:#a6e22e>pageMapQuery</span>{<span style=color:#a6e22e>Prefix</span>: <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>home</span>.<span style=color:#a6e22e>treeRef</span>.<span style=color:#a6e22e>key</span>}, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>n</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>contentNode</span>) {
			<span style=color:#a6e22e>sections</span> = append(<span style=color:#a6e22e>sections</span>, <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>p</span>)
		})

		<span style=color:#a6e22e>setNextPrev</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>pas</span> <span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>Pages</span>) {
			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>pas</span> {
				<span style=color:#a6e22e>np</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>p</span>.(<span style=color:#a6e22e>nextPrevInSectionProvider</span>)
				<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
					<span style=color:#66d9ef>continue</span>
				}

				<span style=color:#a6e22e>pos</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>np</span>.<span style=color:#a6e22e>getNextPrevInSection</span>()
				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pos</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
					<span style=color:#66d9ef>continue</span>
				}

				<span style=color:#a6e22e>pos</span>.<span style=color:#a6e22e>nextPage</span> = <span style=color:#66d9ef>nil</span>
				<span style=color:#a6e22e>pos</span>.<span style=color:#a6e22e>prevPage</span> = <span style=color:#66d9ef>nil</span>

				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> &gt; <span style=color:#ae81ff>0</span> {
					<span style=color:#a6e22e>pos</span>.<span style=color:#a6e22e>nextPage</span> = <span style=color:#a6e22e>pas</span>[<span style=color:#a6e22e>i</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
				}

				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> &lt; len(<span style=color:#a6e22e>pas</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
					<span style=color:#a6e22e>pos</span>.<span style=color:#a6e22e>prevPage</span> = <span style=color:#a6e22e>pas</span>[<span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>]
				}
			}
		}

		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>sect</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>sections</span> {
			<span style=color:#a6e22e>treeRef</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sect</span>.(<span style=color:#a6e22e>treeRefProvider</span>).<span style=color:#a6e22e>getTreeRef</span>()

			<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>pas</span> <span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>Pages</span>
			<span style=color:#a6e22e>treeRef</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>collectPages</span>(<span style=color:#a6e22e>pageMapQuery</span>{<span style=color:#a6e22e>Prefix</span>: <span style=color:#a6e22e>treeRef</span>.<span style=color:#a6e22e>key</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>cmBranchSeparator</span>}, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>contentNode</span>) {
				<span style=color:#a6e22e>pas</span> = append(<span style=color:#a6e22e>pas</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>p</span>)
			})
			<span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>SortByDefault</span>(<span style=color:#a6e22e>pas</span>)

			<span style=color:#a6e22e>setNextPrev</span>(<span style=color:#a6e22e>pas</span>)
		}

		<span style=color:#75715e>// The root section only goes one level down.
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>treeRef</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>home</span>.<span style=color:#a6e22e>getTreeRef</span>()

		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>pas</span> <span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>Pages</span>
		<span style=color:#a6e22e>treeRef</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>collectPages</span>(<span style=color:#a6e22e>pageMapQuery</span>{<span style=color:#a6e22e>Prefix</span>: <span style=color:#a6e22e>treeRef</span>.<span style=color:#a6e22e>key</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>cmBranchSeparator</span>}, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>contentNode</span>) {
			<span style=color:#a6e22e>pas</span> = append(<span style=color:#a6e22e>pas</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>p</span>)
		})
		<span style=color:#a6e22e>page</span>.<span style=color:#a6e22e>SortByDefault</span>(<span style=color:#a6e22e>pas</span>)

		<span style=color:#a6e22e>setNextPrev</span>(<span style=color:#a6e22e>pas</span>)

		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>
	})

	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>init</span>.<span style=color:#a6e22e>menus</span> = <span style=color:#a6e22e>init</span>.<span style=color:#a6e22e>Branch</span>(<span style=color:#66d9ef>func</span>() (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>) {
		<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>assembleMenus</span>()
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>
	})

	<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>init</span>.<span style=color:#a6e22e>taxonomies</span> = <span style=color:#a6e22e>init</span>.<span style=color:#a6e22e>Branch</span>(<span style=color:#66d9ef>func</span>() (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>) {
		<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>pageMap</span>.<span style=color:#a6e22e>assembleTaxonomies</span>()
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
	})
}
</code></pre></div><h2 id=三细枝末节>三、细枝末节</h2>
<h3 id=31-interface-实现约束>3.1 interface 实现约束</h3>
<p>代码中有多处使用如下方式在编译时约束 interface 被实现。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>_</span> <span style=color:#a6e22e>cmder</span> = (<span style=color:#f92672>*</span><span style=color:#a6e22e>newCmd</span>)(<span style=color:#66d9ef>nil</span>)
</code></pre></div><p>其他开源项目中有也有这种写法的：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>_</span> <span style=color:#a6e22e>cmder</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>newCmd</span>{}
<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>_</span> <span style=color:#a6e22e>cmder</span> = <span style=color:#a6e22e>newCmd</span>{}
</code></pre></div><h3 id=32-防抖>3.2 防抖</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>debounce</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;sync&#34;</span>
	<span style=color:#e6db74>&#34;time&#34;</span>
)

<span style=color:#75715e>// New returns a debounced function that takes another functions as its argument.
</span><span style=color:#75715e>// This function will be called when the debounced function stops being called
</span><span style=color:#75715e>// for the given duration.
</span><span style=color:#75715e>// The debounced function can be invoked with different functions, if needed,
</span><span style=color:#75715e>// the last one will win.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>after</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>f</span> <span style=color:#66d9ef>func</span>()) {
	<span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>debouncer</span>{<span style=color:#a6e22e>after</span>: <span style=color:#a6e22e>after</span>}

	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>f</span> <span style=color:#66d9ef>func</span>()) {
		<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>f</span>)
	}
}

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>debouncer</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>mu</span>    <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>
	<span style=color:#a6e22e>after</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
	<span style=color:#a6e22e>timer</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Timer</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>d</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>debouncer</span>) <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>f</span> <span style=color:#66d9ef>func</span>()) {
	<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()

    <span style=color:#75715e>// 如果正在延时中，取消当前延时，添加新的延时
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>timer</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>timer</span>.<span style=color:#a6e22e>Stop</span>()
	}
	<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>timer</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>AfterFunc</span>(<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>after</span>, <span style=color:#a6e22e>f</span>)
}
</code></pre></div><p>防抖函数的使用类似 React Hooks。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>f</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>func</span>()
<span style=color:#a6e22e>run</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>debounce</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>f</span>)
<span style=color:#a6e22e>run</span>()
</code></pre></div><p>在 Istio 源码中，处理 XDS 推流时也会进行防抖处理。</p>
<h3 id=32-lifo-队列>3.2 LIFO 队列</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// LIFO 队列，溢出的元素会从顶部移除
</span><span style=color:#75715e>// 没有主动删除元素的方法
</span><span style=color:#75715e>// EvictingStringQueue is a queue which automatically evicts elements from the head of
</span><span style=color:#75715e>// the queue when attempting to add new elements onto the queue and it is full.
</span><span style=color:#75715e>// This queue orders elements LIFO (last-in-first-out). It throws away duplicates.
</span><span style=color:#75715e>// Note: This queue currently does not contain any remove (poll etc.) methods.
</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>EvictingStringQueue</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>size</span> <span style=color:#66d9ef>int</span>
	<span style=color:#a6e22e>vals</span> []<span style=color:#66d9ef>string</span> <span style=color:#75715e>// 储存真实的数据
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>set</span>  <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>bool</span> <span style=color:#75715e>// 表示是否已经存在
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>mu</span>   <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>
}

<span style=color:#75715e>// NewEvictingStringQueue creates a new queue with the given size.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewEvictingStringQueue</span>(<span style=color:#a6e22e>size</span> <span style=color:#66d9ef>int</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>EvictingStringQueue</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>EvictingStringQueue</span>{<span style=color:#a6e22e>size</span>: <span style=color:#a6e22e>size</span>, <span style=color:#a6e22e>set</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>bool</span>)}
}

<span style=color:#75715e>// Add adds a new string to the tail of the queue if it&#39;s not already there.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>q</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>EvictingStringQueue</span>) <span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>v</span> <span style=color:#66d9ef>string</span>) {
	<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
	<span style=color:#75715e>// 已经存在
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>set</span>[<span style=color:#a6e22e>v</span>] {
		<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
		<span style=color:#66d9ef>return</span>
	}

	<span style=color:#75715e>// 数量达到最大限制
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>set</span>) <span style=color:#f92672>==</span> <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>size</span> {
		<span style=color:#75715e>// Full
</span><span style=color:#75715e></span>		<span style=color:#75715e>// 移除了 0 号元素的占位符
</span><span style=color:#75715e></span>		delete(<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>set</span>, <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>vals</span>[<span style=color:#ae81ff>0</span>])
		<span style=color:#75715e>// :0 取空数组，1:取不包含第一个元素的其余元素
</span><span style=color:#75715e></span>		<span style=color:#75715e>// 移除了数组 0 号元素
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>vals</span> = append(<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>vals</span>[:<span style=color:#ae81ff>0</span>], <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>vals</span>[<span style=color:#ae81ff>1</span>:]<span style=color:#f92672>...</span>)
	}
	<span style=color:#75715e>// 表示存在
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>set</span>[<span style=color:#a6e22e>v</span>] = <span style=color:#66d9ef>true</span>
	<span style=color:#75715e>// 最新插入的值在数组最后
</span><span style=color:#75715e></span>	<span style=color:#75715e>// 是队列结构
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>vals</span> = append(<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>vals</span>, <span style=color:#a6e22e>v</span>)
	<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
}

<span style=color:#75715e>// Contains returns whether the queue contains v.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>q</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>EvictingStringQueue</span>) <span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>v</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>bool</span> {
	<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>set</span>[<span style=color:#a6e22e>v</span>]
}

<span style=color:#75715e>// Peek looks at the last element added to the queue.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>q</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>EvictingStringQueue</span>) <span style=color:#a6e22e>Peek</span>() <span style=color:#66d9ef>string</span> {
	<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
	<span style=color:#a6e22e>l</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>vals</span>)
	<span style=color:#75715e>// 处理边界条件
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>l</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
		<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>
	}
	<span style=color:#75715e>// 取最后一个元素
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>elem</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>vals</span>[<span style=color:#a6e22e>l</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
	<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>elem</span>
}

<span style=color:#75715e>// PeekAll looks at all the elements in the queue, with the newest first.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>q</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>EvictingStringQueue</span>) <span style=color:#a6e22e>PeekAll</span>() []<span style=color:#66d9ef>string</span> {
	<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
	<span style=color:#a6e22e>vals</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>string</span>, len(<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>vals</span>))
	copy(<span style=color:#a6e22e>vals</span>, <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>vals</span>)
	<span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
	<span style=color:#75715e>// i 从头开始循环 j 从尾循环
</span><span style=color:#75715e></span>	<span style=color:#75715e>// 交换 i j 元素位置
</span><span style=color:#75715e></span>	<span style=color:#75715e>// 数组 reverse
</span><span style=color:#75715e></span>	<span style=color:#75715e>// 最后插入的在最前面
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>j</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>, len(<span style=color:#a6e22e>vals</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>j</span>; <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>j</span> = <span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>j</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
		<span style=color:#a6e22e>vals</span>[<span style=color:#a6e22e>i</span>], <span style=color:#a6e22e>vals</span>[<span style=color:#a6e22e>j</span>] = <span style=color:#a6e22e>vals</span>[<span style=color:#a6e22e>j</span>], <span style=color:#a6e22e>vals</span>[<span style=color:#a6e22e>i</span>]
	}
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>vals</span>
}

<span style=color:#75715e>// PeekAllSet returns PeekAll as a set.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>q</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>EvictingStringQueue</span>) <span style=color:#a6e22e>PeekAllSet</span>() <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>bool</span> {
	<span style=color:#a6e22e>all</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>q</span>.<span style=color:#a6e22e>PeekAll</span>()
	<span style=color:#a6e22e>set</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>bool</span>)
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>all</span> {
		<span style=color:#a6e22e>set</span>[<span style=color:#a6e22e>v</span>] = <span style=color:#66d9ef>true</span>
	}

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>set</span>
}
</code></pre></div><h3 id=33-同步信号量>3.3 同步信号量</h3>
<p><code>golang.org/x/sync/semaphore</code> 扩展同步原语。</p>
<h3 id=34-command>3.4 Command</h3>
<h4 id=341-cli-自动补全>3.4.1 CLI 自动补全</h4>
<p>
<figure class=image>
<img src=/2020/12/hugo-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/images/hugo-cli.png alt loading=lazy>
</figure></p>
<p>Hugo 的使用方式有两种：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// &#34;-config&#34; flag 自动补全指定后缀文件名
</span><span style=color:#75715e></span><span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>cc</span>.<span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>PersistentFlags</span>().<span style=color:#a6e22e>SetAnnotation</span>(<span style=color:#e6db74>&#34;config&#34;</span>, <span style=color:#a6e22e>cobra</span>.<span style=color:#a6e22e>BashCompFilenameExt</span>, <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>ValidConfigFileExtensions</span>)

<span style=color:#75715e>// &#34;-source&#34; flag 自动补全子文件夹名
</span><span style=color:#75715e></span><span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>PersistentFlags</span>().<span style=color:#a6e22e>SetAnnotation</span>(<span style=color:#e6db74>&#34;source&#34;</span>, <span style=color:#a6e22e>cobra</span>.<span style=color:#a6e22e>BashCompSubdirsInDir</span>, []<span style=color:#66d9ef>string</span>{})
</code></pre></div><h3 id=35-并发控制>3.5 并发控制</h3>
<h4 id=351-缓冲通道控制并发>3.5.1 缓冲通道控制并发</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#75715e>// common/para/para.go
</span><span style=color:#75715e>// Package para implements parallel execution helpers.
</span><span style=color:#75715e></span><span style=color:#f92672>package</span> <span style=color:#a6e22e>para</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;context&#34;</span>

	<span style=color:#e6db74>&#34;golang.org/x/sync/errgroup&#34;</span>
)

<span style=color:#75715e>// Workers configures a task executor with the most number of tasks to be executed in parallel.
</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Workers</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>sem</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}
}

<span style=color:#75715e>// Runner wraps the lifecycle methods of a new task set.
</span><span style=color:#75715e>//
</span><span style=color:#75715e>// Run wil block until a worker is available or the context is cancelled,
</span><span style=color:#75715e>// and then run the given func in a new goroutine.
</span><span style=color:#75715e>// Wait will wait for all the running goroutines to finish.
</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Runner</span> <span style=color:#66d9ef>interface</span> {
	<span style=color:#a6e22e>Run</span>(<span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>error</span>)
	<span style=color:#a6e22e>Wait</span>() <span style=color:#66d9ef>error</span>
}

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>errGroupRunner</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#f92672>*</span><span style=color:#a6e22e>errgroup</span>.<span style=color:#a6e22e>Group</span>
	<span style=color:#a6e22e>w</span>   <span style=color:#f92672>*</span><span style=color:#a6e22e>Workers</span>
	<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>errGroupRunner</span>) <span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>fn</span> <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>error</span>) {
	<span style=color:#66d9ef>select</span> {
	<span style=color:#75715e>// 分配一个信号, 如果 chan 被关闭则退出
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>sem</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>struct</span>{}{}:
	<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
		<span style=color:#66d9ef>return</span>
	}

	<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>Go</span>(<span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>error</span> {
		<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fn</span>()
		<span style=color:#75715e>// 执行完后消费信号量, 通过缓存通道保证并发执行的协程数量
</span><span style=color:#75715e></span>		<span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>sem</span>
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
	})
}

<span style=color:#75715e>// New creates a new Workers with the given number of workers.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>numWorkers</span> <span style=color:#66d9ef>int</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Workers</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Workers</span>{
		<span style=color:#75715e>// 缓冲通道, 并发写入
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>sem</span>: make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}, <span style=color:#a6e22e>numWorkers</span>),
	}
}

<span style=color:#75715e>// Start starts a new Runner.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>w</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Workers</span>) <span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#a6e22e>Runner</span>, <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) {
	<span style=color:#a6e22e>g</span>, <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>errgroup</span>.<span style=color:#a6e22e>WithContext</span>(<span style=color:#a6e22e>ctx</span>)
	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>errGroupRunner</span>{
		<span style=color:#a6e22e>Group</span>: <span style=color:#a6e22e>g</span>,
		<span style=color:#a6e22e>ctx</span>:   <span style=color:#a6e22e>ctx</span>,
		<span style=color:#a6e22e>w</span>:     <span style=color:#a6e22e>w</span>,
	}, <span style=color:#a6e22e>ctx</span>
}

</code></pre></div><p>Playground 测试示例: <a href=https://play.golang.org/p/4AJtyVnlSOd>https://play.golang.org/p/4AJtyVnlSOd</a></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#a6e22e>w</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>para</span>.<span style=color:#a6e22e>New</span>(<span style=color:#ae81ff>10</span>)
	<span style=color:#a6e22e>runner</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>TODO</span>())
	<span style=color:#a6e22e>runner</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>error</span> {
		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;fucking&#34;</span>)
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
	})
	<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
}
</code></pre></div><h3 id=36-懒加载>3.6 懒加载</h3>
<blockquote>
<p>Lazy 包</p>
</blockquote>
<h4 id=361-oncemore>3.6.1 onceMore</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>lazy</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;sync&#34;</span>
	<span style=color:#e6db74>&#34;sync/atomic&#34;</span>
)

<span style=color:#75715e>// onceMore is similar to sync.Once.
</span><span style=color:#75715e>//
</span><span style=color:#75715e>// Additional features are:
</span><span style=color:#75715e>// * it can be reset, so the action can be repeated if needed
</span><span style=color:#75715e>// * it has methods to check if it&#39;s done or in progress
</span><span style=color:#75715e>//
</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>onceMore</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>mu</span>   <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>
	<span style=color:#a6e22e>lock</span> <span style=color:#66d9ef>uint32</span>
	<span style=color:#a6e22e>done</span> <span style=color:#66d9ef>uint32</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>onceMore</span>) <span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>f</span> <span style=color:#66d9ef>func</span>()) {
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>LoadUint32</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>done</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> {
		<span style=color:#66d9ef>return</span>
	}

	<span style=color:#75715e>// f may call this Do and we would get a deadlock.
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>locked</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>CompareAndSwapUint32</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>lock</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>)
	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>locked</span> {
		<span style=color:#75715e>// 没有抢到原子操作
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>return</span>
	}
	<span style=color:#75715e>// 释放原子锁
</span><span style=color:#75715e></span>	<span style=color:#75715e>// defer 是 FILO, 该原子锁会最后才释放
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>StoreUint32</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>lock</span>, <span style=color:#ae81ff>0</span>)

	<span style=color:#75715e>// 并发锁, 保证 t.done 值的读取不会产生竞争
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()

	<span style=color:#75715e>// Double check
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>done</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> {
		<span style=color:#66d9ef>return</span>
	}
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>StoreUint32</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>done</span>, <span style=color:#ae81ff>1</span>)
	<span style=color:#a6e22e>f</span>()
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>onceMore</span>) <span style=color:#a6e22e>InProgress</span>() <span style=color:#66d9ef>bool</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>LoadUint32</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>lock</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>onceMore</span>) <span style=color:#a6e22e>Done</span>() <span style=color:#66d9ef>bool</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>LoadUint32</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>done</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>onceMore</span>) <span style=color:#a6e22e>ResetWithLock</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span> {
	<span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>StoreUint32</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>done</span>, <span style=color:#ae81ff>0</span>)
	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>mu</span>
}

</code></pre></div><h4 id=362-init>3.6.2 init</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>lazy</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;context&#34;</span>
	<span style=color:#e6db74>&#34;sync&#34;</span>
	<span style=color:#e6db74>&#34;time&#34;</span>

	<span style=color:#e6db74>&#34;github.com/pkg/errors&#34;</span>
)

<span style=color:#75715e>// New creates a new empty Init.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>Init</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Init</span>{}
}

<span style=color:#75715e>// Init holds a graph of lazily initialized dependencies.
</span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Init</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>mu</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span> <span style=color:#75715e>// 并发修改图的锁
</span><span style=color:#75715e></span>
	<span style=color:#a6e22e>prev</span>     <span style=color:#f92672>*</span><span style=color:#a6e22e>Init</span>
	<span style=color:#a6e22e>children</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>Init</span>

	<span style=color:#a6e22e>init</span> <span style=color:#a6e22e>onceMore</span> <span style=color:#75715e>// 保证只执行一次的锁
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>out</span>  <span style=color:#66d9ef>interface</span>{} <span style=color:#75715e>// 执行结果
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>err</span>  <span style=color:#66d9ef>error</span> <span style=color:#75715e>// 执行错误
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>f</span>    <span style=color:#66d9ef>func</span>() (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>) <span style=color:#75715e>// 回调函数
</span><span style=color:#75715e></span>}

<span style=color:#75715e>// Add adds a func as a new child dependency.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ini</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Init</span>) <span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>initFn</span> <span style=color:#66d9ef>func</span>() (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>)) <span style=color:#f92672>*</span><span style=color:#a6e22e>Init</span> {
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ini</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>ini</span> = <span style=color:#a6e22e>New</span>()
	}
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>add</span>(<span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>initFn</span>)
}

<span style=color:#75715e>// AddWithTimeout is same as Add, but with a timeout that aborts initialization.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ini</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Init</span>) <span style=color:#a6e22e>AddWithTimeout</span>(<span style=color:#a6e22e>timeout</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>, <span style=color:#a6e22e>f</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>)) <span style=color:#f92672>*</span><span style=color:#a6e22e>Init</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#66d9ef>func</span>() (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>) {
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>withTimeout</span>(<span style=color:#a6e22e>timeout</span>, <span style=color:#a6e22e>f</span>)
	})
}

<span style=color:#75715e>// Branch creates a new dependency branch based on an existing and adds
</span><span style=color:#75715e>// the given dependency as a child.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ini</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Init</span>) <span style=color:#a6e22e>Branch</span>(<span style=color:#a6e22e>initFn</span> <span style=color:#66d9ef>func</span>() (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>)) <span style=color:#f92672>*</span><span style=color:#a6e22e>Init</span> {
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ini</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
		<span style=color:#a6e22e>ini</span> = <span style=color:#a6e22e>New</span>()
	}
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>add</span>(<span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>initFn</span>)
}

<span style=color:#75715e>// BranchdWithTimeout is same as Branch, but with a timeout.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ini</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Init</span>) <span style=color:#a6e22e>BranchWithTimeout</span>(<span style=color:#a6e22e>timeout</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>, <span style=color:#a6e22e>f</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>)) <span style=color:#f92672>*</span><span style=color:#a6e22e>Init</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>Branch</span>(<span style=color:#66d9ef>func</span>() (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>) {
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>withTimeout</span>(<span style=color:#a6e22e>timeout</span>, <span style=color:#a6e22e>f</span>)
	})
}

<span style=color:#75715e>// Do initializes the entire dependency graph.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ini</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Init</span>) <span style=color:#a6e22e>Do</span>() (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>) {
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ini</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
		panic(<span style=color:#e6db74>&#34;init is nil&#34;</span>)
	}

	<span style=color:#75715e>// 调用 onceMore 库保证只执行一次
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>init</span>.<span style=color:#a6e22e>Do</span>(<span style=color:#66d9ef>func</span>() {
		<span style=color:#75715e>// 获取父节点
</span><span style=color:#75715e></span>		<span style=color:#a6e22e>prev</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>prev</span>
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>prev</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#75715e>// A branch. Initialize the ancestors.
</span><span style=color:#75715e></span>			<span style=color:#75715e>// 若父节点还没有完成初始化, 并且没有正在执行的回调函数, 执行
</span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>prev</span>.<span style=color:#a6e22e>shouldInitialize</span>() {
				<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>prev</span>.<span style=color:#a6e22e>Do</span>()
				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
					<span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>err</span>
					<span style=color:#66d9ef>return</span>
				}
			} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>prev</span>.<span style=color:#a6e22e>inProgress</span>() {
				<span style=color:#75715e>// Concurrent initialization. The following init func
</span><span style=color:#75715e></span>				<span style=color:#75715e>// may depend on earlier state, so wait.
</span><span style=color:#75715e></span>				<span style=color:#75715e>// 等待一定时间, 若没有执行完, panic
</span><span style=color:#75715e></span>				<span style=color:#a6e22e>prev</span>.<span style=color:#a6e22e>wait</span>()
			}
		}

		<span style=color:#75715e>// 执行回调函数
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>f</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
			<span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>out</span>, <span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>f</span>()
		}

		<span style=color:#75715e>// 循环执行子节点的回调函数
</span><span style=color:#75715e></span>		<span style=color:#75715e>// 为什么不并发执行 ?
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>child</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>children</span> {
			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>child</span>.<span style=color:#a6e22e>shouldInitialize</span>() {
				<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>child</span>.<span style=color:#a6e22e>Do</span>()
				<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
					<span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>err</span>
					<span style=color:#66d9ef>return</span>
				}
			}
		}
	})

	<span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>wait</span>()

	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>out</span>, <span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>err</span>
}

<span style=color:#75715e>// TODO(bep) investigate if we can use sync.Cond for this.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ini</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Init</span>) <span style=color:#a6e22e>wait</span>() {
	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>counter</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
	<span style=color:#66d9ef>for</span> !<span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>init</span>.<span style=color:#a6e22e>Done</span>() {
		<span style=color:#a6e22e>counter</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>10</span>
		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>counter</span> &gt; <span style=color:#ae81ff>600000000</span> {
			panic(<span style=color:#e6db74>&#34;BUG: timed out in lazy init&#34;</span>)
		}
		<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>counter</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Microsecond</span>)
	}
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ini</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Init</span>) <span style=color:#a6e22e>inProgress</span>() <span style=color:#66d9ef>bool</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ini</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>init</span>.<span style=color:#a6e22e>InProgress</span>()
}

<span style=color:#75715e>// 若 没有注册了回调函数 | 已经完成 | 正在执行, 不进行初始化
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ini</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Init</span>) <span style=color:#a6e22e>shouldInitialize</span>() <span style=color:#66d9ef>bool</span> {
	<span style=color:#66d9ef>return</span> !(<span style=color:#a6e22e>ini</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>init</span>.<span style=color:#a6e22e>Done</span>() <span style=color:#f92672>||</span> <span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>init</span>.<span style=color:#a6e22e>InProgress</span>())
}

<span style=color:#75715e>// Reset resets the current and all its dependencies.
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ini</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Init</span>) <span style=color:#a6e22e>Reset</span>() {
	<span style=color:#a6e22e>mu</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>init</span>.<span style=color:#a6e22e>ResetWithLock</span>()
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>children</span> {
		<span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Reset</span>()
	}
}

<span style=color:#75715e>// 添加图的节点
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ini</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Init</span>) <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>branch</span> <span style=color:#66d9ef>bool</span>, <span style=color:#a6e22e>initFn</span> <span style=color:#66d9ef>func</span>() (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>)) <span style=color:#f92672>*</span><span style=color:#a6e22e>Init</span> {
	<span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()

	<span style=color:#75715e>// 如果是新建分支
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>branch</span> {
		<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Init</span>{
			<span style=color:#a6e22e>f</span>:    <span style=color:#a6e22e>initFn</span>,
			<span style=color:#a6e22e>prev</span>: <span style=color:#a6e22e>ini</span>, <span style=color:#75715e>// 父节点
</span><span style=color:#75715e></span>		}
	}

	<span style=color:#75715e>// 如果是添加子节点
</span><span style=color:#75715e></span>	<span style=color:#75715e>// 如果已经被执行, panic
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>checkDone</span>()
	<span style=color:#75715e>// 添加子节点
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>children</span> = append(<span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>children</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Init</span>{
		<span style=color:#a6e22e>f</span>: <span style=color:#a6e22e>initFn</span>,
	})

	<span style=color:#75715e>// 释放锁
</span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ini</span>
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ini</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Init</span>) <span style=color:#a6e22e>checkDone</span>() {
	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ini</span>.<span style=color:#a6e22e>init</span>.<span style=color:#a6e22e>Done</span>() {
		panic(<span style=color:#e6db74>&#34;init cannot be added to after it has run&#34;</span>)
	}
}

<span style=color:#75715e>// callback 函数, 有超时时间
</span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ini</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Init</span>) <span style=color:#a6e22e>withTimeout</span>(<span style=color:#a6e22e>timeout</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>, <span style=color:#a6e22e>f</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>)) (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>) {
	<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>timeout</span>)
	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
	<span style=color:#75715e>// 缓存通道, 防止阻塞
</span><span style=color:#75715e></span>	<span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>verr</span>, <span style=color:#ae81ff>1</span>)

	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
		<span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>(<span style=color:#a6e22e>ctx</span>)
		<span style=color:#66d9ef>select</span> {
		<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
			<span style=color:#66d9ef>return</span>
		<span style=color:#66d9ef>default</span>:
			<span style=color:#a6e22e>c</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>verr</span>{<span style=color:#a6e22e>v</span>: <span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>err</span>: <span style=color:#a6e22e>err</span>}
		}
	}()

	<span style=color:#66d9ef>select</span> {
	<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;timed out initializing value. You may have a circular loop in a shortcode, or your site may have resources that take longer to build than the `timeout` limit in your Hugo config file.&#34;</span>)
	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>ve</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>c</span>:
		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ve</span>.<span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>ve</span>.<span style=color:#a6e22e>err</span>
	}
}

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>verr</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>v</span>   <span style=color:#66d9ef>interface</span>{}
	<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
}

</code></pre></div><p>参考文章：</p>
<p>[1] <a href=https://imroc.io/posts/kubernetes/analysis-exitcode/>Kubernetes 问题定位技巧：分析 ExitCode - imroc.io|roc的博客|Cloud Native|Kubernetes|Go|Golang</a></p>
<aside class="flex space-x-3 space-y-4 text-sm sm:items-center sm:flex-wrap sm:justify-end flex-col sm:flex-row">
<div class=flex-grow></div>
<a class="block text-raven-600 hover:text-raven-900" target=_blank rel="noopener nofollow" title href="https://twitter.com/intent/tweet?text=Hugo%20%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20%7c%20Unknown%20%2f2020%2f12%2fhugo-%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB%2f">
<div class="flex space-x-2 items-center">
<div><svg class="w-6 h-6 fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11.0 01-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56.0 00-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57.0 002.914 5.452 6.48 6.48.0 01-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42.0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57A13.18 13.18.0 011.57 26.146c-.538.0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072.0 18.672-10 18.672-18.668.0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg>
</div>
<span class=block>Share on Twitter</span>
</div>
</a>
<a class="block text-raven-600 hover:text-raven-900" target=_blank rel="noopener nofollow" title href="https://www.facebook.com/dialog/share?app_id=&display=page&href=%2f2020%2f12%2fhugo-%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB%2f">
<div class="flex space-x-2 items-center">
<div><svg class="w-6 h-6 fill-current" viewBox="-7 -3.5 39 39" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M30.234.0H1.765C.8.001.0.79.0 1.766v28.47C.001 31.2.79 32 1.766 32h15.328V19.625h-4.156V14.78h4.156v-3.564c0-4.134 2.523-6.384 6.21-6.384 1.766.0 3.284.13 3.726.2v4.32h-2.543c-2.006.0-2.394.953-2.394 2.352v3.085h4.797l-.625 4.844h-4.172V32h8.14C31.21 32 32 31.2 32 30.234V1.765C32 .8 31.21.0 30.234.0z"/></svg>
</div>
<span class=block>Share on Facebook</span>
</div>
</a>
</aside>
</article>
</div>
</div>
</div>
</div>
</main>
<footer class=footer>
<div class="ax-l-i max-w-6xl">
<nav class="flex items-center justify-center">
</nav>
<div class="footer-copyright text-sm text-center text-gray-400 mt-4">
&#169; -2021 Mayo's Blog
</div>
<div class="text-sm sm:text-xs text-center text-gray-400 mt-2">
<a href="https://www.axiomtheme.com/?utm_source=theme-footer&utm_medium=website&utm_campaign=referral"></a>
</div>
</div>
</footer>
<script src="/bundle.js?v=1631904279"></script>
</body>
</html>